by Brian Tomasik
First written: Apr. 2015; last update: <REPLACE>date_of_last_update</REPLACE>

<span style="color:red">The sample size for the results in this piece is tiny because it's still in test mode. Hence, the results aren't especially useful!</span>
<span style="color:red">This piece is still a draft. Please give feedback. :) </span>

<h2>Summary</h2>

Investing with leverage means borrowing money to buy stocks/ETFs/etc. In theory, leverage offers higher <i>expected</i> ending wealth but also higher risk and usually even lower <i>median</i> ending wealth. Leverage is not for everyone, even all altruists, but if you have money you want to donate down the road that you can afford to lose without major consequences, then investing it with leverage may be a reasonable choice.

The easiest way is to buy and hold leveraged ETFs. Most advisors warn that doing this is a terrible idea because such funds usually lose money, but from what I can tell, leveraged ETFs do have higher expected value for nearly risk-neutral investors. If you're willing to put in more manual effort, margin investing can achieve similar results without the expense ratio of leveraged ETFs.

Before getting carried away with the details of whether and how to use leverage, the more important question is whether and how much of your money to donate to invest in the first place. I plan to donate most of my future earnings immediately while saving some money to invest with leverage for donating later.<!--I simulated margin vs. regular investing and found that over <REPLACE>years_until_donate</REPLACE> years, for someone saving <REPLACE>initial_annual_income_for_investing</REPLACE>/year with a <REPLACE>annual_real_income_growth_percent</REPLACE>% real annual growth in savings and various other assumptions, using margin investing results in an expected present value of ~<REPLACE>margin_better_than_regular</REPLACE> more eventual donatable savings than not using it, which is about a <REPLACE>margin_better_than_regular_percent</REPLACE>% improvement.-->

<h3>Caveat</h3>

I'm not a professional investor or economist. This piece relies on the best understanding I've been able to gather as an amateur, and I don't yet have experience actually doing leveraged investing. Don't put too much weight on what I say for your own investment decisions. There are probably errors in my analysis and small bugs in my code, so I encourage readers to give me feedback. Also, my discussion assumes you live in the USA, and many details (especially about taxes) may not extend to other countries.

<span style="color:orange">REMINDER to self: if I ever switch the default to not rebalancing monthly, I'd need to change the "results vs. theory" configurations to force monthly rebalancing to make the numbers comparable</span>

[toc]

<h2>Introduction</h2>

Many financial commentators advise against <a href="http://en.wikipedia.org/wiki/Leverage_%28finance%29">leveraging</a> investments due to the higher risk that it involves. An excellent, simple, graphical tutorial on leverage is "<a href="http://papers.ssrn.com/sol3/papers.cfm?abstract_id=2239827" title="by Robert Ferguson, 1993">The Danger of Leverage and volatility</a>". I agree it's generally true that most individuals shouldn't leverage non-retirement assets if they plan to use those assets for personal consumption.

But what if you plan to donate the invested assets? You should <a href="http://reducing-suffering.org/when-should-altruists-be-financially-risk-averse/" title="&quot;When Should Altruists Be Financially Risk-Averse?&quot;">generally be less risk-averse</a> with funds you plan to donate than with funds you plan to spend on yourself because the marginal altruistic utility of donated dollars usually doesn't decline as sharply as the marginal egoistic utility of dollars for personal consumption. Does this suggest that leverage could be a promising strategy for investments you plan to donate?

This essay explores that question. The short answer is "maybe, depending on (1) your altruistic risk tolerance and (2) expectations of future stock-market returns and borrowing interest rates." In particular, I think margin investing is a promising avenue to consider if you're donating to a cause where the marginal utility of additional dollars is relatively flat, even over large scales (e.g., if the overall charitable cause had 5 times the budget, it would produce almost 5 times the value). It's probably not a good idea if you plan to donate to small, startup charities or to causes where the marginal value of additional money declines to a nontrivial degree.

<!--
TAKE THIS OUT BECAUSE IT'S ONLY A NAIVE ANALYSIS AND IS SUPERCEDED BY SIMULATION NUMBERS
<h2>How much is leverage worth?</h2>

The value of leverage depends on the current interest rate for borrowing and expected stock returns. As an example, in 2015, <a href="http://en.wikipedia.org/wiki/Margin_(finance)">margin</a> interest rates <a href="https://www.interactivebrokers.com/en/index.php?f=interest&p=schedule2" title="&quot;Interest Rates Charged to You on Margin Loan Balances&quot;">at Interactive Brokers</a> are less than 1.5% for large investment amounts. A conservative estimate of future stock returns might be 5%. This implies in expectation about a 3.5% net return per year. Suppose you have $500K to invest. If you use 2:1 leverage and borrow another $500K to invest, and if it returns a net 3.5%/year in expectation, that amounts to an extra $17.5K/year in expectation. Maybe we should reduce the expected returns to 2% to account for risk and the possibility of error. Then leverage is worth $10K/year in expectation. Over many years, this adds up to a nontrivial amount.

If you don't already have a lot to invest, the total gains from leverage will of course be lower. In this piece, I describe a simulation in which a hypothetical wage earner invests over the course of 30 years, contributing <REPLACE>initial_annual_income_for_investing</REPLACE>/year to savings in early years and up to $54K/year in late years. The results are presented <a href="#Results">later</a>.
-->

<h2>Should you invest before donating?</h2>

This piece is mainly targeted toward altruists who want to donate a few years or decades down the road but are saving their money for now, perhaps because they want to wait to pick out a charity or because their desired charities don't yet exist. Some might also feel that the returns on capital-market investments exceed the returns on direct altruism work. But before jumping into details about whether to invest using leverage, you should first ask: Do I want to invest before donating at all?

There's <a href="http://www.effective-altruism.com/ea/4e/giving_now_vs_later_a_summary/" title="'Giving now vs. later: a summary' by Julia Wise">much</a> <a href="http://effective-altruism.com/ea/4e/giving_now_vs_later_a_summary/3bq" title="'Brian_Tomasik comments on Giving now vs. later: a summary - Effective Altruism Forum'">discussion</a> of the question of whether to donate now or later. For my personal situation, I think the optimal strategy is to donate some amount now toward projects that are either very underfunded or that should be done sooner rather than later. For instance, the <a href="http://foundational-research.org/">Foundational Research Institute</a> is more urgent than a regular charity because its conclusions will help me direct the remainder of my donations. For the rest of my donations, I'd rather wait at least a decade, because I'm continuing to learn a lot, and my conclusions may change with new insights.

<!--
This explains why the altruist in my simulations only invests ~<REPLACE>initial_annual_income_for_investing</REPLACE>/year rather than a larger amount. It's because she's donating much of the remainder, either to charities directly or at least to a DAF to max out her 50%-of-AGI limit.
-->



<h2>Possible leverage methods</h2>

Following are some methods that are often proposed for leveraging investments. I haven't tried any of them yet firsthand, though I hope to experiment with margin investing soon. Chapter 8 of <i><a href="http://smile.amazon.com/Lifecycle-Investing-Audacious-Performance-Retirement-ebook/dp/B003GYEGK2/">Lifecycle Investing</a></i> by Ian Ayres and Barry Nalebuff also surveys these leverage methods.

<h3>Margin</h3>

<a href="http://en.wikipedia.org/wiki/Margin_(finance)">Margin</a> investing involves borrowing money from a broker to buy additional stocks/ETFs. By far the <a href="http://investorjunkie.com/12389/best-margin-rates/" title="&quot;Best Margin Rates&quot;">best margin rates</a> are offered by Interactive Brokers. However, note that Interactive Brokers requires that you have a minimum account balance of <a href="https://www.interactivebrokers.com/en/index.php?f=4969" title="&quot;Required Minimums&quot;">$10K</a>, a minimum liquid net worth of <a href="https://www.interactivebrokers.com/en/?f=accountConfiguration&p=tradingrequirements" title="&quot;Financial Information Requirements&quot;">$100K</a>, and experience making at least <a href="https://www.interactivebrokers.com/en/?f=accountConfiguration&p=tradingrequirements" title="&quot;Financial Information Requirements&quot;">100 securities trades</a> on another platform.

<h4>Arguments for margin:</h4>

<ul>
<li>It's more clear that margin investing has the returns you'd expect, because it doesn't rely on market pricing of options and futures.</li>
<li>Unlike options, futures, and leveraged ETFs, if you buy stocks/ETFs on margin, you can hold them indefinitely unless you need to sell to rebalance your portfolio. This means you can potentially hold securities for many years and then donate them when you're ready, thereby never incurring capital-gains tax. In contrast, options and futures typically need to be sold at least once per year, and leveraged ETFs incur some tax costs through daily rebalancing. Frequent buying and selling also incurs some transactions costs via trading fees and bid-ask spreads.</li>
<li>In the USA, margin interest <a href="https://ttlc.intuit.com/questions/2260392-is-margin-interest-paid-tax-deductible">can offset</a> net investment income, thereby potentially reducing taxes.</li>
</ul>

<h4>Arguments against margin:</h4>

<ul>
<li>It requires some work to manually watch your leverage amount, pay margin interest, and record all of this on tax returns.</li>
</ul>

Margin accounts don't allow for high leverage ratios (e.g., 10X or 20X) the way options and futures do. That said, high leverage ratios also require diligent monitoring, since if the price drops even a small amount, you might need to sell many of your assets. For instance, a 5% price drop with 20X leverage destroys your whole account. The authors of <i>Lifecycle Investing</i> suggest a maximum of 2X leverage.

<h3>Options</h3>

<i>Lifecycle Investing</i> recommends buying long call options at about half the current price of the security for ~2X leverage. A <a href="http://www.bogleheads.org/forum/viewtopic.php?f=1&t=88487" title="&quot;Lifecycle Investing Leverage Strategy Using LEAPS - How To?&quot;">Bogleheads thread</a> describes more details.

A friend tells me the following:
<blockquote>
About options, you want your effective interest rate to be as close to the risk free rate as possible.  To do that, you want as little time value as possible.  That means deep in the money call options, although a synthetic stock is reasonable [...].
</blockquote>

<h4>Arguments for options:</h4>

<ul>
<li>Implied margin interest rates might be competitive for highly liquid options markets, though a friend reports that implied interest rates are unfavorable for thinner markets.</li>
<li>Maybe less manual work than managing a margin account.</li>
<li>(Not sure if this is true.) A minor consideration is that because options don't pay dividends, you don't have to pay income tax on dividends in a taxable account. (But this is more than counteracted by needing to pay capital-gains taxes on the options themselves.)</li>
</ul>

<h4>Arguments against options:</h4>

<ul>
<li>Need to sell every year or so, which means paying capital-gains taxes that you could avoid from buy-and-hold margin investing. As an example, suppose you sell a <a href="https://en.wikipedia.org/wiki/LEAPS_(finance)">LEAP</a> every 11 months, and say this gives an annual expected return of 7%. Because your capital gains are short-term, you pay, e.g., 28% tax on the gains. That leaves you with a 5% post-tax return.</li>
<li><a href="http://reducing-suffering.org/do-call-options-have-high-expected-returns/" title="&quot;Do Call Options Have High Expected Returns?&quot;">It appears</a> that out-of-the-money call options have very bad expected returns, contrary to theoretical predictions that they should have very good expected returns. Paul Christiano <a href="http://effective-altruism.com/ea/h8/best_way_to_invest_with_leverage/36w" title="&quot;Paul_Christiano comments on Best way to invest with leverage? - Effective Altruism Forum&quot;">seems to suggest</a> that one explanation for this could be that out-of-the-money options are thinly traded. I don't know the answer, but the fact that returns can deviate so sharply from theory at least makes me worried about using options in other contexts. I'd like to learn more about option returns deep in the money (which is the <a href="https://en.wikipedia.org/wiki/Moneyness">moneyness</a> that <i>Lifecycle Investing</i> encourages), but in the meantime, an ordinary margin account seems safer.</li>
<li>A friend tells me: "I've been disappointed with options as a source of leverage. Compared to margin loans, there aren't many securities with options. And of securities with options, many of those options are illiquid and basically can't be traded. Of those options that can be traded, the effective interest rate is considerably higher than [Interactive Brokers]'s highest margin rate." <a href="http://finance.yahoo.com/q?s=SPY">SPY</a> may have low-ish implied interest rates, but as is discussed later, there are reasonable concerns about levering the US stock market in particular as of ~2015.</li>
</ul>

<h3>Index futures</h3>

Buying futures on, say, the S&P 500 index can multiply your market exposure possibly 10X or 20X. I haven't explored this option enough to comment much on it.

<h4>Arguments for futures:</h4>

<ul>
<li>...</li>
</ul>

<h4>Arguments against futures:</h4>

<ul>
<li>Need to sell every ~3 months or so, which means paying capital-gains taxes that you could avoid if you used buy-and-hold margin investing.</li>
<li>May be hard to find a broker that allows futures trading.</li>
<li>As later results suggest, leverage of 10X or more is probably unwise even from a risk-neutral standpoint because it makes it so likely you'll get wiped out in the long run.</li>
</ul>

<h3>Leveraged ETFs</h3>

<h4>Arguments for leveraged ETFs:</h4>

<ul>
<li>By far the easiest way to get leverage, since you can buy them in a normal brokerage account without setting up margin or options/futures trading. If you buy and hold, you can also just leave them alone until you want to dispose of them.</li>
<li>(Not sure if this is true for all leveraged ETFs.) Since leveraged ETFs use non-dividend-paying derivatives to achieve leverage, they tend not to have distributions, which is good if you're in a taxable account.((This point is explained in a <a href="http://www.proshares.com/media/fact_sheet/ProSharesFactSheetEET.pdf" title="'Fact Sheet as of 3/31/15 ProShares Ultra MSCI Emerging Markets'">ProShares fact sheet</a>, and you can see that the fund historically <a href="http://www.proshares.com/funds/eet_distributions.html">has had almost no distributions</a>.)) However, this point is trivial compared with the higher taxes that leveraged ETFs may pay on average from higher turnover.</li>
</ul>

<h4 id="arguments_against_leveraged_ETFs">Arguments against leveraged ETFs:</h4>

<ul>
<li>The expense ratios may be ~1% for a service that you could basically replicate on your own with a 2X margin account.</li>
<li>Due to turnover of the assets in the fund, taxes may be greater than with buy-and-hold margin investing, and capital gains <a href="http://www.dailyfinance.com/2010/02/09/exotic-etfs-may-hide-an-unpleasant-tax-surprise/" title="'Exotic ETFs May Hide an Unpleasant Tax Surprise'">may often be</a> treated as short-term regardless of how long you hold the fund. According to "<a href="http://etfdb.com/leveraged-etfs/leveraged-etf-faqs/" title="'Leveraged ETFs: Frequent Asked Questions (FAQs)'">one page</a>: "Capital gains distributions from leveraged ETFs became an issue in 2008 when Rydex reported distributions of as much as 70% of fund assets. [That is, if the gain was $X, and if your tax bracket was 28%, you would have paid $X * 70% * 28%, or about $X * 20%.] In 2009, Direxion reported moderate capital gains on some of its funds while ProShares reported zero capital gains distributions." <a href="http://www.dailyfinance.com/2010/02/09/exotic-etfs-may-hide-an-unpleasant-tax-surprise/" title="'Exotic ETFs May Hide an Unpleasant Tax Surprise'">Another article</a> quotes Andy O'Rourke: "Both ProShares and Rydex paid zero capital gains on all of the leveraged ETFs. Direxion Shares ETFs also paid capital gains on only 11 of their funds, and no amount greater than 15% of assets." Taxes on distributions from leveraged ETFs are <a href="http://www.direxioninvestments.com/wp-content/uploads/2012/11/Understanding-Taxable-Distributions.pdf" title="'Understanding Taxable Distributions'">less of an issue for short-term traders</a>, but most of us are not (and should not try to be) short-term traders. Moreover, if you're investing prior to donating to a 501(c)(3) charity, then you never pay capital-gains taxes if you buy and hold, so any premature distributions or capital gains are bad. I think taxes are plausibly an important reason to disprefer leveraged ETFs even if you're risk-neutral, since a margin account can accomplish the same end with much lower taxes.</li>
<li>I assume (?) that frequent buying and selling also means transactions costs, bid/ask spreads, etc.</li>
</ul>

<h3>Home mortgage</h3>

A home mortgage is one of the most common form of leveraged investing (with another being college loans).

<h4>Arguments for home mortgages:</h4>

<ul>
<li>Popular and safe method.</li>
<li>Mortgage interest is deductible. Moreover, whereas margin interest is only deductible to offset net investment income, mortgage interest doesn't have the same restriction, so it's deductible even if you have net capital losses. (This is just my impression from cursory reading. Readers, please correct me if it's wrong.)</li>
</ul>

<h4>Arguments against home mortgages:</h4>

<ul>
<li><a href="http://www.bankrate.com/finance/mortgages/current-interest-rates.aspx" title="'Current Mortgage Interest Rates'">Mortgage interest rates</a> are higher than margin rates from Interactive Brokers.</li>
</ul>

Whether to get a home mortgage depends crucially on whether you want to buy a house in general. There's <a href="https://www.google.com/search?q=rent%20vs.%20buy">much discussion</a> on that question, and following are a few considerations:

<h4>Arguments for buying a house/condo:</h4>

<ul>
<li><a href="http://www.bankrate.com/finance/money-guides/home-sale-capital-gains-1.aspx" title="'Capital gains and your home sale'">Exclusion from</a> $250K ($500K if married) of capital gains when you sell a house.</li>
<li>You avoid paying taxes on "rent" to yourself, whereas a landlord pays taxes on rent from a tenant. For example, suppose a living space is worth $1000/month intrinsically. If you own it, you're "paying" yourself $1000/month of rent tax-free. If you instead rent it, since you want to get back $1000/month after taxes (assume a 28% tax rate), you have to charge your tenant $1280/month. Hence, the renter pays more. (Thanks to a friend for this point.)</li>
</ul>

<h4>Arguments against buying a house/condo:</h4>

<ul>
<li>Buying and selling is a lot of hassle if you move frequently.</li>
<li>Have to take care of property taxes, repairs, and home improvements yourself.</li>
<li>Real estate is plausibly a worse investment than stocks because people buy real estate partly as a consumption good, i.e., houses have positive "convenience yield". And historically, houses <a href="http://www.cbsnews.com/news/history-says-home-real-estate-is-a-bad-investment/" title="'History says home real estate is a bad investment'">have probably</a> underperformed stocks, though the difference in performance is much smaller when one considers savings from not paying rent.</li>
</ul>

<h2>Tentative conclusion among leverage methods</h2>

Given what I know so far, buying index ETFs on margin looks like it has the least model uncertainty, i.e., is least likely to blow up for unexpected reasons. Margin buying is sometimes advocated even for normal investors, such as <a href="http://www.mathisen.ca/leveraging/leveraging.pdf" title="&quot;Understanding Investment Leverage&quot;">by Manulife Bank of Canada</a>. This increases my confidence that the strategy probably works.

"<a href="http://www.investmentreview.com/files/2009/12/leveraged_portfolios1.pdf">Leveraged Canadian Stock Portfolios: Long-Run Effects on Wealth and Risk</a>" (Figure 2) found that margin investing at 1.8X leverage was optimal in terms of median long-run performance, based on random monthly returns from 1950 to 2001 and assuming monthly rebalancing. <span style="color:red">(check that I got these details correct; reread study)</span>


<h2>Warnings</h2>

<h3>General</h3>

Margin investing seems relatively complex, so I plan to try it out with small amounts of money at first, until I learn the mechanics and tax implications.

If you don't have the time to learn the details of margin investing, it's probably best to shy away from it.

<h3>About Interactive Brokers</h3>

The Interactive Brokers (IB) Customer Agreement warns that IB may liquidate positions if margin exceeds limits without issuing a margin call, i.e., without giving you a chance to add more money. IB reserves the right to liquidate whichever securities they want without telling you. This seems bad in part because IB might(??) liquidate short-term rather than long-term assets, thereby increasing the capital-gains taxes you'll pay. To avoid this, I would probably manually maintain a margin amount less than the limit so that I'm the one who manually does rebalancing when necessary. For instance, if IB allows at most a <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>% margin-to-assets ratio, I might manually impose a cap of <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% on my own.

IB's Customer Agreement also says: "Customer acknowledges Customer's responsibility for knowing the terms of any securities, options, warrants or other products in Customer's account, including upcoming corporate actions (e.g., tender offers, reorganizations, stock splits, etc.). IB has no obligation to notify Customer of deadlines or required actions or dates of meetings, nor is IB obligated to take any action without specific written instructions sent by Customer to IB electronically through the IB website." Presumably this is less of a problem if you're investing in index ETFs, but if you invest in individual stocks, watch out! I own individual stocks in my regular brokerage account, and I would guess that ~1-3% of them per year have issued <a href="http://reducing-suffering.org/advanced-tips-on-personal-finance/#Tender_offers">tender offers</a> requiring shareholders to either accept the offer or sell the security before it becomes worthless. If you miss the deadline, you just lost the value of the security.

If you already have assets with another broker, you should use <a href="http://ibkb.interactivebrokers.com/video/1136" title="&quot;How to Deposit Funds Via a Full ACATS/ATON Transfer&quot;">ACATS</a> to transfer your securities to Interactive Brokers. You shouldn't sell your securities and then wire the money, because this incurs capital-gains tax! Select only a "Partial" transfer unless you want to move your whole brokerage account. Doing only a partial transfer <a href="http://www.moneycone.com/switching-brokers-what-you-need-to-know-to-avoid-getting-hit-with-fees/" title="&quot;Switching brokers? What you need to know to avoid getting hit with fees!&quot;">might save on ACAT fees</a> by your old broker. If you have shares purchased using ESPP, you may need a special form for transferring, so call your broker about that. Since Interactive Brokers says in the quote from the previous paragraph that they may not report <a href="https://en.wikipedia.org/wiki/Corporate_action">corporate actions</a>, I didn't transfer big amounts of small/mid-cap stocks to Interactive Brokers in case Interactive Brokers's reporting of tender offers/etc. is inferior to that of my existing broker, but I hope to learn more about this over time.
<!--
ADD:

http://en.wikipedia.org/wiki/Portfolio_margin vs. Regulation T
-->

<h3>Invest in foreign ETFs?</h3>

Many commentators believe that the US stock market is overpriced as of ~2015. This is <a href="http://www.starcapital.de/research/stockmarketvaluation" title="'Global Stock Market Valuation Ratios'">suggested by</a> most fundamental-valuation metrics. As a result, it may be best to buy mostly global equity ETFs, rather than the US S&P 500. Even if you (like me) have strong efficient-market intuitions, it at least shouldn't <i>hurt</i> to buy global ETFs except for slightly higher expense ratios and bid/ask spreads. These seem worth the cost of reducing exposure to the possible US stock-market bubble as of ~2015.

<h3>Social impact of leverage</h3>

Using leverage to increase the amount you can donate to charity is very likely a net positive socially. That said, it's worth thinking about the direct social impact of using margin. Usually people say that margin investing increases financial instability by amplifying both positive and negative returns. When the market declines, people using leverage have too much debt and so need to sell some of their positions to restore their leverage ratios, which pushes prices down further.

Margin investing also slightly increases demand for loans, pushing interest rates slightly higher. I would also guess that when more money is invested in stocks, the willingness of companies to IPO increases slightly, since companies can expect higher prices for their initial shares, but I haven't read this anywhere, so it could be completely wrong. These seem like small effects, and it's not obvious if they're good or bad anyway.

I assume that more people investing in stocks pushes down long-run (if not short-run) stock-market returns because the fundamental value of the companies being invested in is fixed. If so, then gains from margin investing are zero-sum in the sense that they come from other investors. However, since most investors would spend the money on themselves (and most people who can afford to invest in the stock market are reasonably well off to begin with), this doesn't seem like a huge altruistic downside.

<h2>Leverage for retirement?</h2>

PUT THIS IN SECTION ON RETIREMENT: THEN ADD IRA AFTER THAT.

<i>Lifecycle Investing</i> makes the case that most young people should leverage their investments early in life. Here's a summary of the argument: "<a href="http://content.time.com/time/business/article/0,8599,1982327,00.html">Why Young People Should Buy Stocks on Margin</a>". The logic is almost obvious in hindsight, and if you expect a fairly normal professional career trajectory, it may apply to you.

For altruists, there's an additional reason to consider leverage: Many altruists should be more risk-neutral than most non-altruists. How much this is true depends on</a> the charities that the altruist wants to support. Leverage offers the promise of higher expected returns in exchange for potentially higher risk. (That said, one of the theses of <i>Lifecycle Investing</i> is that leverage could also decrease lifetime risk if it allows you to reduce the aggressiveness of your investments in later years.)


<h3>IRA to avoid taxes?</h3>

The tax disadvantages of options and futures can be avoided if you're trading in an IRA. However, note that if you can't get a tax deduction for a traditional IRA, then a <a href="http://reducing-suffering.org/advanced-tips-on-personal-finance/#Could_you_also_use_IRAs_for_this_purpose">traditional IRA is a bad deal</a> because you pay income-tax rates both before adding money and when withdrawing it. You can currently avoid this problem using a <a href="http://www.bogleheads.org/wiki/Backdoor_Roth_IRA">backdoor Roth IRA</a>, but it's <a href="http://www.forbes.com/sites/ashleaebeling/2015/02/02/obama-budget-would-prohibit-backdoor-roth-iras/" title="&quot;Obama Budget Would Prohibit Backdoor Roth IRAs&quot;">not clear</a> that this will continue to work forever, and managing one requires nontrivial effort for only ~$5500 of contributions per year. Assuming you save well over ~$5500 per year, you'd still need another leverage method for your other investments.

Another risk with margin investing in IRAs is that if you get a margin call and deposit more funds into the account, you might exceed the IRS limits for the maximum amount you can add to the account per year. The Interactive Brokers Margin Disclosure <a href="https://www.interactivebrokers.com/en/?f=%2Fen%2Faccounts%2FlegalDocuments%2FsemiAnnualDisclosures.php" title="&quot;Semi-Annual Disclosures&quot;">says</a>: "Deposits to the account in excess of [IRS] limits may cause adverse tax consequences, including but not limited to, forfeiture of the tax-advantaged status of the IRA account and/or penalties." That said, this may not be a problem if you always pay margin calls by selling equity rather than depositing more funds.


<h2>Theoretical leverage performance</h2>

You might think that because leverage involves holding twice as much equity as regular investing that (ignoring loan interest), the performance of a 2X leveraged position would just be 2 times the performance of regular equity investing, with double the possible gains and double the possible losses, but with the distribution having the same general shape.

This is not how leverage actually performs. Volatility distorts the distribution of outcomes. As a result, 2X leverage usually does worse than twice the underlying asset, and often it does worse than the underlying asset itself. For example, the US SEC issued <a href="http://www.sec.gov/investor/pubs/leveragedetfs-alert.htm" title="'Leveraged and Inverse ETFs: Specialized Products with Extra Risks for Buy-and-Hold Investors'">an alert</a> containing the following anecdote: "Between December 1, 2008, and April 30, 2009, a particular index gained 2 percent. However, a leveraged ETF seeking to deliver twice that index's daily return fell by 6 percent [...]."

So why would anyone use leverage? Because it offers small probabilities of huge gains. Higher and higher leverage amounts become like lottery tickets in a lottery where the expected value is actually better than fair, as will be discussed below.

<h3>Simple example</h3>

Let's start with a simple case. Something like this is commonly used when discussing leveraged ETFs.

<h4>Regular investing</h4>

Suppose you have $100 in an index ETF. There are only two possible returns for the ETF in a given period: up 10% or down 10%. Each has equal probability. Let R<sub>i</sub> be a random variable for the return of the ETF in period i. R<sub>i</sub> is either .1 or -.1.

There are four possible outcomes, each equally likely:
<ul>
<li>$100(1+.1)(1+.1) = $121</li>
<li>$100(1-.1)(1+.1) = $99</li>
<li>$100(1+.1)(1-.1) = $99</li>
<li>$100(1-.1)(1-.1) = $81</li>
</ul>
Your expected ending wealth is ($121 + $99 + $99 + $81)/4 = $100, just like you'd expect naively. But your <i>median</i> ending wealth is $99. In other words, even regular stock-market investing contains a bias toward losing some money in terms of the <i>median</i> (not mean) outcome. The reason we don't usually notice this is that the stock-market has a general upward trend, which hides this small drag from volatility.

We can approximate the effect of drag as follows. Note that E[R<sub>i</sub>] = 0 and Var[R<sub>i</sub>] = E[R<sub>i</sub><sup>2</sup>] - E[R<sub>i</sub>]<sup>2</sup> = E[R<sub>i</sub><sup>2</sup>] - 0 = E[.01] = .01. The median outcome was $1 lower than the mean, i.e., was $100 * Var[R<sub>i</sub>] lower.

<h4>Leveraged investing</h4>

The reason the SEC and others warn about leverage is just that it amplifies this volatility drag. To see this, note that a leveraged version of the above ETF would have possible returns of +20% and -20%, giving these four possible outcomes:
<ul>
<li>$100(1+.2)(1+.2) = $144</li>
<li>$100(1-.2)(1+.2) = $96</li>
<li>$100(1+.2)(1-.2) = $96</li>
<li>$100(1-.2)(1-.2) = $64</li>
</ul>
Your expected ending wealth is ($144 + $96 + $96 + $64)/4 = $100, just like before. But the median ending wealth is now $96, and the worst case is much worse. This is typical of leverage: it makes many of the outcomes worse but some of the outcomes vastly better.

Now Var[R<sub>i</sub>] = E[R<sub>i</sub><sup>2</sup>] - E[R<sub>i</sub>]<sup>2</sup> = E[R<sub>i</sub><sup>2</sup>] - 0 = E[.04] = .04. The median outcome was $4 lower than the mean, i.e., was $100 * Var[R<sub>i</sub>] lower. 2X leverage means 4X variance, so the drag is actually quadratic in the leverage amount.

<h3>Geometric Brownian motion model</h3>

<h4>Regular investing</h4>

The most common model of stock-market evolution is geometric Brownian motion. Let S<sub>t</sub> be the price of a stock or ETF at year t. The <a href="https://en.wikipedia.org/wiki/Geometric_Brownian_motion#Technical_definition:_the_SDE">geometric Brownian motion stochastic differential equation</a> (SDE) is
<blockquote>
dS<sub>t</sub>/S<sub>t</sub> = &mu; dt + &sigma; dW<sub>t</sub>,
</blockquote>
where &mu; is the expected annual return, &sigma; is the annual volatility, and W<sub>t</sub> is a Weiner process with mean 0 and variance t. That is, if Z is a standard-normal random variable, then dW<sub>t</sub> = Z&radic;<span style="text-decoration: overline">dt</span>.

Solving this SDE <a href="https://en.wikipedia.org/wiki/Geometric_Brownian_motion#Solving_the_SDE">tells us</a> that
<blockquote>
S<sub>t</sub> = S<sub>0</sub> exp(&mu;t - &sigma;<sup>2</sup>t/2 + &sigma;W<sub>t</sub>). &nbsp;&nbsp;&nbsp;  (call this the "<span id="regular_S_t" style="color:green">regular S<sub>t</sub> equation</span>")
</blockquote>
S<sub>t</sub>/S<sub>0</sub> has a <a href="https://en.wikipedia.org/wiki/Log-normal_distribution">lognormal distribution</a> with location parameter &mu;t - &sigma;<sup>2</sup>t/2 and scale parameter &sigma;&radic;<span style="text-decoration: overline">t</span>.

The <a href="https://en.wikipedia.org/wiki/Log-normal_distribution#Mode_and_median">median</a> of a lognormal distribution is exp(location_parameter). Thus
<blockquote>
median(S<sub>t</sub>/S<sub>0</sub>) = exp(&mu;t - &sigma;<sup>2</sup>t/2), &nbsp;&nbsp;&nbsp;which implies<br />
median(S<sub>t</sub>) = S<sub>0</sub> exp(&mu;t - &sigma;<sup>2</sup>t/2) &nbsp;&nbsp;&nbsp;  (call this the "<span id="regular_median" style="color:green">regular median equation</span>")
</blockquote>
because S<sub>0</sub> is constant and so doesn't affect the sorted ranking of S<sub>t</sub> values. Here we can see the same volatility drag discussed before, in the &#8209;&sigma;<sup>2</sup>t/2. See <a href="https://en.wikipedia.org/wiki/It%C5%8D%27s_lemma#Geometric_Brownian_motion">here</a> for more discussion of this "convexity correction" term.

The mean of a lognormal distribution is exp(location_parameter + scale_parameter<sup>2</sup>/2). Hence
<blockquote>
mean(S<sub>t</sub>/S<sub>0</sub>) = exp(&mu;t - &sigma;<sup>2</sup>t/2 + [&sigma;&radic;<span style="text-decoration: overline">t</span>]<sup>2</sup>/2) = exp(&mu;t), &nbsp;&nbsp;&nbsp;which implies that<br />
mean(S<sub>t</sub>) = S<sub>0</sub> exp(&mu;t), &nbsp;&nbsp;&nbsp; (call this the "<span id="regular_mean" style="color:green">regular mean equation</span>")
</blockquote>
since the constant S<sub>0</sub> can come out of the mean() operator. This equation is confirmed <a href="https://en.wikipedia.org/wiki/Geometric_Brownian_motion#Properties">by Wikipedia</a>. We see that volatility doesn't drag down the mean; it just skews the distribution such that most of the outcomes (including the median) are lower.

<h4>Leveraged investing</h4>

Let V<sub>t</sub> denote the net wealth of a leveraged portfolio at year t. (V<sub>t</sub> is just like S<sub>t</sub> but for leveraged investing.) <a href="http://www.fsa.ulaval.ca/nfa2003/papiers/Craig%20Wilson.pdf" title="'Leveraged Stock Portfolios over Long Holding Periods: A Continuous Time Model' (2003)">Domian et al. (2003)</a> show (p. 5, eqn. 13) that for a c-times leveraged portfolio (e.g., c = 2 means 2X leverage) and borrowing interest rate r, the applicable SDE is
<blockquote>
dV<sub>t</sub>/V<sub>t</sub> = (r + (&mu;-r)c) dt + c &sigma; dW<sub>t</sub>.
</blockquote>
This makes sense because the infinitesimal expected return should be c&mu; dt, the infinitesimal standard deviation should be c&sigma;, and the infinitesimal borrowing cost should be (c-1)r dt (since only c-1 of the purchased units are borrowed).

<a href="http://www.fsa.ulaval.ca/nfa2003/papiers/Craig%20Wilson.pdf" title="'Leveraged Stock Portfolios over Long Holding Periods: A Continuous Time Model' (2003)">Domian et al. (2003)</a> solve this equation (p. 5, eqn. 14) in the same way we solved the <a href="#regular_S_t">regular S<sub>t</sub> equation</a>. The result is
<blockquote>
V<sub>t</sub> = V<sub>0</sub> exp{ (r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c&sigma;W<sub>t</sub> }. &nbsp;&nbsp;&nbsp;  (call this the "<span id="leveraged_V_t" style="color:green">leveraged V<sub>t</sub> equation</span>")
</blockquote>
V<sub>t</sub>/V<sub>0</sub> is lognormal with location parameter (r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 and scale parameter c&sigma;&radic;<span style="text-decoration: overline">t</span>.

In analogy with before, we have
<blockquote>
median(V<sub>t</sub>) = V<sub>0</sub> exp{location_parameter} = V<sub>0</sub> exp{(r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2} &nbsp;&nbsp;&nbsp;  (call this the "<span id="leveraged_median" style="color:green">leveraged median equation</span>")
</blockquote>
We can see that the volatility drag is quadratic in the leverage amount (c<sup>2</sup>).

Likewise:
<blockquote>
mean(V<sub>t</sub>) = V<sub>0</sub> exp(location_parameter + scale_parameter<sup>2</sup>/2) = V<sub>0</sub> exp{(r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c<sup>2</sup>&sigma;<sup>2</sup>t/2} = V<sub>0</sub> exp{(r + (&mu;-r)c) t} &nbsp;&nbsp;&nbsp;  (call this the "<span id="leveraged_mean" style="color:green">leveraged mean equation</span>")
</blockquote>
This result can also be written as V<sub>0</sub> exp{[&mu;c-r(c-1)] t}. This is exactly what we would have thought naively: The performance of leveraged investing is c times the underlying asset performance, minus (c-1) times loan interest (since we only take out a loan for c-1 of the total investment amount).

<h4>Comparison between regular and leveraged</h4>

Consider equal starting investments of $K between a regular (c = 1) and leveraged (c > 1) portfolio: S<sub>0</sub> = V<sub>0</sub> = K. Suppose &mu; > r, as is usually the case.

Using the median equations just derived:
<blockquote>
median(V<sub>t</sub>) / median(S<sub>t</sub>) = [ K exp{(r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2} ] / [ K exp(&mu;t - &sigma;<sup>2</sup>t/2) ]<br />
= exp{(r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 - &mu;t + &sigma;<sup>2</sup>t/2 }<br />
= exp{rt + &mu;ct - rct (1 - c<sup>2</sup>)&sigma;<sup>2</sup>t/2 - &mu;t }<br />
= exp{ &mu;(c-1)t - r(c-1)t (1 - c<sup>2</sup>)&sigma;<sup>2</sup>t/2 }<br />
= exp{ (&mu;-r)(c-1)t + (1 - c<sup>2</sup>)&sigma;<sup>2</sup>t/2 }.
</blockquote>
The exact appearance of this curve depends on the input parameters. <a href="https://www.wolframalpha.com/input/?i=plot%5B++exp%28+%28.054-.03%29*%28c-1%29*15+%2B+%281+-+c%5E2%29*.22%5E2+*+15%2F2+%29%2C+c%2C+0%2C+5%5D">Here</a>'s what it looks like with one reasonable set of parameters (including &mu; = 0.054) and <a href="https://www.wolframalpha.com/input/?i=plot%5B++exp%28+%28.09-.03%29*%28c-1%29*15+%2B+%281+-+c%5E2%29*.22%5E2+*+15%2F2+%29%2C+c%2C+0%2C+5%5D">here</a>'s with a more optimistic &mu;=0.09. Most of the time, the curve is less than 1, i.e., using leverage implies a <i>lower</i> median return. Presumably this is a main reason why the SEC warns against leveraged ETFs: They typically do underperform regular ETFs.

However, the story is different when it comes to mean returns. Using the mean equations just derived:
<blockquote>
mean(V<sub>t</sub>) / mean(S<sub>t</sub>) = [K exp{(r + (&mu;-r)c) t}] / [K exp(&mu;t)] = exp{(r + (&mu;-r)c) t - &mu;t)} = exp{rt + &mu;ct - rct - &mu;t)} = exp{(&mu;-r)(c-1)t}.
</blockquote>
Since &mu;-r > 0 and c-1 > 0, this ratio is greater than 1 and increases with t. Here's one sample calculation of this ratio with particular parameter choices:
<blockquote>
mean(V<sub>t</sub>) / mean(S<sub>t</sub>) = exp{(&mu;-r)(c-1)t} = exp{(<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)(<REPLACE>broker_imposed_leverage_limit</REPLACE>-1) * <REPLACE>years_until_donate</REPLACE>} = <REPLACE>mean_margin_over_mean_regular</REPLACE>.
</blockquote>
For instance, if you can make an expected $100K with normal investments, you'd make (in expectation, not median) <REPLACE>$100K * mean(V_t)/mean(S_t)</REPLACE>K with <REPLACE>broker_imposed_leverage_limit</REPLACE>X leverage.

So (at least in this simplified theoretical model), leverage does indeed offer higher expected ending wealth than non-leveraged investing. The catch, of course, is that most investors -- even most altruists -- shouldn't be risk-neutral with respect to wealth. The next section discusses what levels of risk aversion might be reasonable when it comes to wealth that will be donated.

Also note that this continuous-time model doesn't allow margin accounts to go bankrupt. Because a continuous-time margin account maintains constant leverage, if its assets fall, it rebalances immediately by selling some securities. In the real world, margin accounts can go bankrupt. This could, with low probability, even happen if the account rebalances daily. For instance, a 5X-leveraged margin account that rebalanced once per day might have been wiped out by <a href="https://en.wikipedia.org/wiki/Black_Monday_(1987)">1987's Black Monday</a>. By not allowing for bankruptcy (and by ignoring <a href="https://en.wikipedia.org/wiki/Black_swan_theory">black swans</a> in general), continuous-time equations like those above may slightly overstate the expected value of leverage.

<h2>What's your altruistic risk tolerance?</h2>

Suppose you're donating to support some overall cause, such as safety of artificial general intelligence. Typically a cause has diminishing marginal value with additional dollars. This is for <a href="http://reducing-suffering.org/when-should-altruists-be-financially-risk-averse/" title="&quot;When Should Altruists Be Financially Risk-Averse?&quot;">various reasons</a>, such as that the best people are employed first and for the lowest wages, and that lowest-hanging fruit for solving the problem tend to be plucked first.

Within a given cause, some projects may have more value for you than others. For instance, maybe you like one charity a lot more than other charities for the same cause. In that case, maybe looking at just that charity's funding is the right unit of abstraction. But that individual charity will also usually show diminishing marginal value with funding.

Say we've picked some level of abstraction (a cause, a charity, etc.) that we want to fund. It seems plausible that the good g that's accomplished by a given number of dollars d given to that cause/charity is d<sup>&gamma;</sup> for some &gamma; in the interval (0,1]. &gamma; = 1 corresponds to no diminishing marginal good, but this seems rare. More plausible values of &gamma; might be 0.9 or 0.75 or 0.5.

You are one individual planning to donate to the cause/charity. Let your donation amount be m (short for "myself"). Let the donation amount of all the other donors be o (short for "others"). Then the total good done is g(m+o) = (m+o)<sup>&gamma;</sup>.

g(d) defines the <i>cause or charity's</i> utility function with respect to total donated dollars. But it's also helpful to define your <i>individual</i> altruistic utility function with respect to dollars you personally donate. Below, I refer to this as utility(wealth), and I approximate it by (wealth)<sup>&alpha;</sup> for some &alpha;. It's easy to get this confused with the charity's utility function of d<sup>&gamma;</sup> for some &gamma;. Just remember that if you see a &gamma;, it reflects the utility function of the charity, while &alpha; refers to your personal altruistic utility function with respect to how much money you can personally donate.

<h3>Case 1: You are the charity's main donor</h3>

If m >> o, then g(m+o) is roughly m<sup>&gamma;</sup>. In such a case, the good you accomplish is roughly your wealth raised to the &gamma;, so for investment decisions, you should maximize expected utility, with utility(wealth) = (wealth)<sup>&gamma;</sup>. That is, &alpha; = &gamma;.

<h3>Case 2: Many donors, you're not very correlated with them</h3>

Suppose that m << o, and the returns you earn on your investments aren't appreciably correlated with how much others donate. In this case, the marginal contribution of your donation, m, is
<blockquote>
utility(wealth) = g(m+o) - g(o) = (m+o)<sup>&gamma;</sup> - o<sup>&gamma;</sup>.
</blockquote>
As an example, suppose o = 10<sup>7</sup> and m ranges between 0 and 10<sup>6</sup>. Basically regardless of &gamma;, utility(wealth) is almost linear in wealth, i.e., &alpha; &asymp; 1. For instance, <a href="https://www.wolframalpha.com/input/?i=plot%5B+%28m+%2B+10%5E7%29%5E.5+-+%2810%5E7%29%5E.5%2C+m%2C+0%2C+1000000%5D">here</a>'s the curve for &gamma;=0.5.

This is consistent with the naive intuition that if an organization is big, then small amounts of additional donations should have roughly linear impact, since the marginal utility of donations shouldn't level off that much. In particular, if g(d) = d<sup>&gamma;</sup>, the derivative at o (i.e., you donate nothing) is g'(o) = &gamma; o<sup>&gamma;-1</sup>, while the derivative at m+o (i.e., you do donate m) is g'(m+o) = &gamma; (m+o)<sup>&gamma;-1</sup>. The ratio is
This is consistent with the naive intuition that if an organization is big, then small amounts of additional donations should have roughly linear impact, since the marginal utility of donations shouldn't level off that much. In particular, if g(d) = d<sup>&gamma;</sup>, the derivative at o (i.e., you donate nothing) is g'(o) = &gamma; o<sup>&gamma;-1</sup>, while the derivative at m+o (i.e., you do donate m) is g'(m+o) = &gamma; (m+o)<sup>&gamma;-1</sup>. The ratio is
This is consistent with the naive intuition that if an organization is big, then small amounts of additional donations should have roughly linear impact, since the marginal utility of donations shouldn't level off that much. In particular, if g(d) = d<sup>&gamma;</sup>, the derivative at o (i.e., you donate nothing) is g'(o) = &gamma; o<sup>&gamma;-1</sup>, while the derivative at m+o (i.e., you do donate m) is g'(m+o) = &gamma; (m+o)<sup>&gamma;-1</sup>. The ratio is
<blockquote>
g'(m+o) / g'(o) = [ &gamma; (m+o)<sup>&gamma;-1</sup> ] / [ &gamma; o<sup>&gamma;-1</sup> ] = [(m+o)/o]<sup>&gamma;-1</sup> = [o/(m+o)]<sup>1-&gamma;</sup>.
</blockquote>
o/(m+o) is close to 1 for o >> m, and 1-&gamma; is some exponent like 0.1 or 0.5. Taking a fractional exponent of a number slightly less than 1 just makes the result even closer to 1. Hence, the ratio of derivatives is nearly 1, showing that marginal utility doesn't decline that much regardless of how much you donate as long as your donations are small relative to the total.

This scenario makes leverage look promising because for a linear utility function, maximizing expected utility means maximizing expected wealth.

One example of a high-risk situation where your returns aren't highly correlated with those of other donors is entrepreneurship. Carl Shulman <a href="https://80000hours.org/2012/01/salary-or-startup-how-do-gooders-can-gain-more-from-risky-careers/" title="'Salary or startup? How do-gooders can gain more from risky careers'">suggests</a> that altruistic donors should be more risk-neutral than egoistic spenders.

In most domains besides entrepreneurship, non-<a href="https://en.wikipedia.org/wiki/Systematic_risk">systematic risk</a> can be diversified away, so the only risk is systematic risk (called "<a href="https://en.wikipedia.org/wiki/Beta_(finance)">beta</a>"). The risk from leverage is mainly systematic risk, since the leveraged portfolio aims for a multiple of the underlying asset. Systematic risk is likely to be correlated with others' donations, so we now turn to focusing on that case.

<h3>Case 3: Many correlated donors</h3>

<i>Note: This section is weird, and I'm not at all sure I'm thinking about it correctly. So what I say here may be wrong.</i>

This section expands upon <a href="http://reducing-suffering.org/when-should-altruists-be-financially-risk-averse/#Money_is_less_valuable_in_richer_worlds">this discussion</a> and takes inspiration from "<a href="http://rationalaltruist.com/2013/02/28/risk-aversion-and-investment-for-altruists/">Risk aversion and investment (for altruists)</a>" by Paul Christiano.

Let S<sub>t</sub> be the normalized value of some underlying market index, like a global equity index fund. By "normalized" I mean that, for instance, it's relative to S<sub>0</sub> = $1. You pursue some investment strategy, possibly including leverage, based on S<sub>t</sub>, so your final wealth is a function m(S<sub>t</sub>) of S<sub>t</sub>. Likewise, at least some other donors have exposure to S<sub>t</sub>, so their donations are also a function o(S<sub>t</sub>) of S<sub>t</sub>. For example, suppose that half of other donors have assets uncorrelated with equities, and the other half have everything they plan to donate in the equity index fund or equivalent portfolios. Then o(S<sub>t</sub>) = N * (1/2 + S<sub>t</sub>/2), where N is some scaling factor, 1/2 is from the non-equity assets, and S<sub>t</sub>/2 is from the equity assets whose donated value is proportional to the index performance.

The value that you contribute by your donation is the difference in good done by the cause/charity with your donations vs. without them:
<blockquote>
utility(your wealth) = utility(m(S<sub>t</sub>)) = g(m(S<sub>t</sub>) + o(S<sub>t</sub>)) - g(o(S<sub>t</sub>)) = (m(S<sub>t</sub>) + o(S<sub>t</sub>))<sup>&gamma;</sup> - o(S<sub>t</sub>)<sup>&gamma;</sup>.
</blockquote>
Our goal in the remainder of this section is to approximate the above equation in the simpler form utility(m(S<sub>t</sub>)) &prop; (m(S<sub>t</sub>))<sup>&alpha;</sup> for some appropriate &alpha;, so that we can later evaluate your utility of investment wealth more compactly as just (wealth)<sup>&alpha;</sup> for some &alpha;. I wrote "&prop;" rather than "=" because scalar constants multiplied by a utility function won't affect decisions, since what maximizes expected utility also maximizes expected (k * utility) for any constant k.

Suppose o(S<sub>t</sub>) = N S<sub>t</sub><sup>&eta;</sup> for some constant N and some &eta; in the interval [0,&infin;). This reflects the idea that people give more when the stock market is doing well. If &eta;=1, this means that people's total donations are a constant fraction of their accumulated stock-market assets. (In practice, &eta; could be higher or lower.) Then 
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + N S<sub>t</sub><sup>&eta;</sup>)<sup>&gamma;</sup> - (N S<sub>t</sub><sup>&eta;</sup>)<sup>&gamma;</sup>. &nbsp;&nbsp;&nbsp;  (call this "<span id="utility_equation1" style="color:green">utility equation 1</span>")
</blockquote>

Say you're following a c-times leveraged strategy, so that m(S<sub>t</sub>) = M V<sub>t</sub>, where M is some constant, and V<sub>t</sub> is the performance of the leveraged investment, normalized to the same scale as S<sub>t</sub>, e.g., normalized such that V<sub>0</sub> = $1. Combining the <a href="#regular_S_t">regular S<sub>t</sub> equation</a> and the <a href="#leveraged_V_t">leveraged V<sub>t</sub> equation</a> and assuming that V<sub>0</sub> = S<sub>0</sub> = 1:
<blockquote>
V<sub>t</sub> / S<sub>t</sub><sup>c</sup> = [exp{ (r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c&sigma;W<sub>t</sub> }] / [exp(&mu;tc - &sigma;<sup>2</sup>tc/2 + &sigma;cW<sub>t</sub>)]<br />
= exp{ rt + &mu;ct - rct - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c&sigma;W<sub>t</sub> - &mu;tc + &sigma;<sup>2</sup>tc/2 - &sigma;cW<sub>t</sub> }<br />
= exp{ rt - rct - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + &sigma;<sup>2</sup>tc/2 }<br />
= exp{ (1-c)rt + (c-c<sup>2</sup>)&sigma;<sup>2</sup>t/2 }, which is a constant (independent of S<sub>t</sub>).((This equation can also be found in eqn. 10 on p. 9 of "<a href="http://www.math.nyu.edu/faculty/avellane/LeveragedETF20090515.pdf">Path-dependence of Leveraged ETF returns</a>" with f = 0, &beta; = c, &lambda; = 0, and &sigma;<sub>s</sub> having a constant value &sigma; for all s. One thing that worries me about this equation is that it depends on t. I seem to be implicitly assuming that you and all other donors have the same investment time horizon. This is obviously wrong in practice. Do my conclusions change if this assumption is ignored? I'm still very confused about this point.)) Denote it by q.
</blockquote>
So
<blockquote>
m(S<sub>t</sub>) = M V<sub>t</sub> = M q S<sub>t</sub><sup>c</sup>.
</blockquote>
Inversely:
<blockquote>
[m(S<sub>t</sub>)/(Mq)]<sup>1/c</sup> = S<sub>t</sub>.
</blockquote>
Substituting back into <a href="#utility_equation1">utility equation 1</a>:
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + N [m(S<sub>t</sub>)/(Mq)]<sup>&eta;/c</sup>)<sup>&gamma;</sup> - {N [m(S<sub>t</sub>)/(Mq)]<sup>&eta;/c</sup>}<sup>&gamma;</sup>. &nbsp;&nbsp;&nbsp;  (call this "<span id="utility_equation2" style="color:green">utility equation 2</span>")
</blockquote>
Finally we have utility purely as a function of your own donation amount that factors in its correlation with others' donations. Now let's see what shape the function has given some plausible parameter values.

Take M = 10<sup>5</sup>, meaning the absolute amount you donate is $100,000 times V<sub>t</sub>/V<sub>0</sub>. Suppose N = 10<sup>7</sup>, which means the scale of others' donations is about 100 times yours. Assume &eta;=1 for simplicity.

<h4>Simple scenario: c=1</h4>

Suppose you don't leverage investments (c=1). Then q=1. <a href="#utility_equation2">Utility equation 2</a> becomes
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + N m(S<sub>t</sub>)/M)<sup>&gamma;</sup> - (N m(S<sub>t</sub>)/M)<sup>&gamma;</sup>.
</blockquote>
N/M = 100, i.e., total funding for the cause/charity is roughly 100 times your donations. So
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + 100 m(S<sub>t</sub>))<sup>&gamma;</sup> - (100 m(S<sub>t</sub>))<sup>&gamma;</sup><br />
= (101 m(S<sub>t</sub>))<sup>&gamma;</sup> - (100 m(S<sub>t</sub>))<sup>&gamma;</sup><br />
= 101<sup>&gamma;</sup> m(S<sub>t</sub>)<sup>&gamma;</sup> - 100<sup>&gamma;</sup> m(S<sub>t</sub>)<sup>&gamma;</sup><br />
= (101<sup>&gamma;</sup> - 100<sup>&gamma;</sup>) m(S<sub>t</sub>)<sup>&gamma;</sup>.
</blockquote>
For a given &gamma;, the first factor is constant. Hence, the value of your donation scales as utility(wealth) &prop; (wealth)<sup>&gamma;</sup> -- just like it did when we assumed you were the only major donor! This is because, when all donors are perfectly correlated according to market performance, it's <a href="http://effective-altruism.com/ea/h8/best_way_to_invest_with_leverage/36m" title="Paul Christiano says: 'as if there were one giant philanthropist'">as though there's only one big donor</a> (who donates 101 m(S<sub>t</sub>)), and his/her donations have value (wealth)<sup>&gamma;</sup>.

<h4>Scenario: c=2</h4>

Let's calculate q with the following parameter choices:
<blockquote>
q = exp{ (1-c)rt + (c-c<sup>2</sup>)&sigma;<sup>2</sup>t/2 }<br />
= exp{ (1-2) * 0.03 * 15 + (2-2<sup>2</sup>) * 0.22<sup>2</sup> * 15/2 }<br />
= 0.3.
</blockquote>

Then <a href="#utility_equation2">utility equation 2</a> becomes
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + N [m(S<sub>t</sub>)/(M * .3)]<sup>1/2</sup>)<sup>&gamma;</sup> - {N [m(S<sub>t</sub>)/(M * .3)]<sup>1/2</sup>}<sup>&gamma;</sup><br />
= (m(S<sub>t</sub>) + 10<sup>7</sup> [m(S<sub>t</sub>)/(30000)]<sup>1/2</sup>)<sup>&gamma;</sup> - {10<sup>7</sup> [m(S<sub>t</sub>)/(30000)]<sup>1/2</sup>}<sup>&gamma;</sup><br />
= (m(S<sub>t</sub>) + 10<sup>7</sup> &radic;<span style="text-decoration: overline">m(S<sub>t</sub>)</span>/173.2)<sup>&gamma;</sup> - (10<sup>7</sup> &radic;<span style="text-decoration: overline">m(S<sub>t</sub>)</span>/173.2)<sup>&gamma;</sup><br />
= (m(S<sub>t</sub>) + 57737 &radic;<span style="text-decoration: overline">m(S<sub>t</sub>)</span>)<sup>&gamma;</sup> - (57737 &radic;<span style="text-decoration: overline">m(S<sub>t</sub>)</span>)<sup>&gamma;</sup>.
</blockquote>
Even for &gamma; = 0.5, say, <a href="https://www.wolframalpha.com/input/?i=plot%5B+%28m+%2B+57737+sqrt%28m%29%29%5E.5+-+%2857737+sqrt%28m%29%29%5E.5%2C+m%2C+0%2C+1000000%5D">this curve</a> is relatively linear in m(S<sub>t</sub>), and for &gamma; closer to 1, it's almost perfectly straight.

<h4>Scenario: c=3</h4>

<blockquote>
q = exp{ (1-c)rt + (c-c<sup>2</sup>)&sigma;<sup>2</sup>t/2 }<br />
= exp{ (1-3) * 0.03 * 15 + (3-3<sup>2</sup>) * 0.22<sup>2</sup> * 15/2 }<br />
= 0.046.
</blockquote>

Then <a href="#utility_equation2">utility equation 2</a> becomes
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + N [m(S<sub>t</sub>)/(M * 0.046)]<sup>1/3</sup>)<sup>&gamma;</sup> - {N [m(S<sub>t</sub>)/(M * 0.046)]<sup>1/3</sup>}<sup>&gamma;</sup><br />
= (m(S<sub>t</sub>) + 10<sup>7</sup> [m(S<sub>t</sub>)/(4600)]<sup>1/3</sup>)<sup>&gamma;</sup> - {10<sup>7</sup> [m(S<sub>t</sub>)/(4600)]<sup>1/3</sup>}<sup>&gamma;</sup><br />
= (m(S<sub>t</sub>) + 10<sup>7</sup> m(S<sub>t</sub>)<sup>1/3</sup>/16.6)<sup>&gamma;</sup> - (10<sup>7</sup> m(S<sub>t</sub>)<sup>1/3</sup>/16.6)<sup>&gamma;</sup><br />
= (m(S<sub>t</sub>) + 602400 m(S<sub>t</sub>)<sup>1/3</sup>)<sup>&gamma;</sup> - (602400 m(S<sub>t</sub>)<sup>1/3</sup>)<sup>&gamma;</sup>.
</blockquote>
Even for &gamma; = 0.5, say, <a href="https://www.wolframalpha.com/input/?i=plot%5B+%28m+%2B+602400m%5E%281%2F3%29%29%5E.5+-+%28602400+m%5E%281%2F3%29%29%5E.5%2C+m%2C+0%2C+1000000%5D">this curve</a> is relatively linear in m(S<sub>t</sub>), and for &gamma; closer to 1, it's almost perfectly straight.

<h4>Take-home lessons</h4>

<ul>
<li>If you're a small donor relative to the total, and if the donations of others aren't significantly correlated with your investment performance, then you should be roughly risk-neutral with your investments, which implies a strong prima facie case for leverage.</li>
<li>On the other hand, if you're one of the few donors to the cause/charity, or if your investment returns are highly correlated with others' donations and you don't use leverage, then the shape of your utility function for ending wealth will be utility(wealth) &prop; (wealth)<sup>&gamma;</sup>, where &gamma; reflects the charity's degree of diminishing returns to total financial resources.</li>
<li>When you use leverage, your returns are proportional to a power of ordinary returns, so the utility added by a certain amount of investment return becomes closer to linear in wealth (i.e., you become closer to risk-neutral again). I'm not very confident in this conclusion because it's counterintuitive and might be wrong.</li>
</ul>

In the remainder of this piece, I assume that utility(wealth) = (wealth)<sup>&alpha;</sup> for some fixed value &alpha; regardless of leverage, but it's important to note that this assumption is actually not true when there are other donors whose returns are correlated with yours. In this situation, if you use leverage, the correct personal &alpha; to use is higher than (and implies a utility function more linear than) the &gamma; value for the cause/charity. Because &alpha; increases with leverage, assuming a constant &alpha; actually understates the case for leverage. If the cause or charity is tiny and your donations account for most of the funding, then of course a constant &alpha; = &gamma; value is indeed appropriate.

In the results below, I present both average wealth (corresponding to &alpha;=1) and average &radic;<span style="text-decoration: overline">wealth</span> (corresponding to &alpha;=0.5). Probably the correct &alpha; to use lies somewhere in between these extremes.

Finally, keep in mind that stability of donations might be valuable even apart from diminishing marginal value of additional wealth, since it allows recipient charities to better plan, experience less budget-induced turnover of staff and projects, etc. The analysis of how this affects &alpha; might be similar as above:
<ol>
<li>If you're the main donor, it argues against variance.</li>
<li>If you're a small part of all donations and not correlated with others, variance doesn't matter as much because blips up and down can be smoothed out by the recipient organizations to some extent.</li>
<li>If you're correlated with other donors, then variance again becomes problematic because the organization might lose lots of donations all at once.</li>
</ol>
That said, if the organization isn't counting on your donations, then these stability arguments become less pressing. If you make a single, big, unexpected donation, the charity can smooth it out over time. If you donate regularly, then variability in how much you donate per period is bad, but if you're drawing down a given accumulation of savings, you can artificially keep donations constant by donating a fixed amount per year regardless of investment performance.

<!--
<h4>Scenario: huge c</h4>

What happens when we have lots of leverage? Note that
<blockquote>
(1/q)<sup>1/c</sup> = exp{ [ -(1-c)rt - (c-c<sup>2</sup>)&sigma;<sup>2</sup>t/2 ]/c }<br />
= exp{ -(1/c-1)rt - (1-c)&sigma;<sup>2</sup>t/2 }<br />
= exp{ (1-1/c)rt + (c-1)&sigma;<sup>2</sup>t/2 }.
</blockquote>
Since &sigma;<sup>2</sup> is typically about the same size as r, when c becomes big, this is dominated by exp{ (c-1)&sigma;<sup>2</sup>t/2 }.

Now <a href="#utility_equation2">utility equation 2</a> becomes
<blockquote>
utility(m(S<sub>t</sub>)) = (m(S<sub>t</sub>) + N [m(S<sub>t</sub>)/M)]<sup>1/c</sup> exp{ (c-1)&sigma;<sup>2</sup>t/2 } )<sup>&alpha;</sup> - {N [m(S<sub>t</sub>)/(M)]<sup>1/c</sup> exp{ (c-1)&sigma;<sup>2</sup>t/2 } }<sup>&alpha;</sup>
</blockquote>


BELOW NOT USED...

As we saw with the <a href="#regular_S_t">regular S<sub>t</sub> equation</a>, S<sub>t</sub>/S<sub>0</sub> has a lognormal distribution with location parameter &mu;t - &sigma;<sup>2</sup>t/2 and scale parameter &sigma;&radic;<span style="text-decoration: overline">t</span>. As shorthand, let's denote this by
<blockquote>
S<sub>t</sub>/S<sub>0</sub> ~ LN[&mu;t - &sigma;<sup>2</sup>t/2, &sigma;<sup>2</sup>t].
</blockquote>
This implies
<blockquote>
S<sub>t</sub> ~ LN[ln(S<sub>0</sub>) + &mu;t - &sigma;<sup>2</sup>t/2, &sigma;<sup>2</sup>t].<br />
S<sub>t</sub><sup>&eta;</sup> ~ LN[ln(S<sub>0</sub>)&eta; + &mu;t&eta; - &sigma;<sup>2</sup>t&eta;/2, &sigma;<sup>2</sup>&eta;<sup>2</sup>t/4].<br />
o(S<sub>t</sub>) = N * S<sub>t</sub><sup>&eta;</sup> ~ LN[ln(S<sub>0</sub>)&eta; - ln(N) + &mu;t&eta; - &sigma;<sup>2</sup>t&eta;/2, &sigma;<sup>2</sup>&eta;<sup>2</sup>t/4].<br />
o(S<sub>t</sub>)<sup>&alpha;</sup> = (N * S<sub>t</sub><sup>&eta;</sup>)<sup>&alpha;</sup> ~ LN[ln(S<sub>0</sub>)&eta;&alpha; - ln(N)&alpha; + &mu;t&eta;&alpha; - &sigma;<sup>2</sup>t&eta;&alpha;/2, &sigma;<sup>2</sup>&eta;<sup>2</sup>&alpha;<sup>2</sup>t/4].<br />
</blockquote>
-->

<h4>Donating to causes with different &gamma;'s</h4>

Some of the <a href="http://reducing-suffering.org/donation-recommendations/">charities</a> I plan to give toward have relatively low &gamma;'s. For instance, the &gamma; of the <a href="http://foundational-research.org/">Foundational Research Institute</a> might be 0.5 or so. Currently I'm one of the main donors, so my personal &alpha; is also close to 0.5.

In contrast, the <a href="http://reducing-suffering.org/why-i-support-the-humane-slaughter-association/">Humane Slaughter Association</a> probably has a cause-wide &gamma; closer to 0.8 or something, since the cause of humane slaughter scales pretty well with additional funding, at least at this stage when many major improvements are still needed. Moreover, the organization already gets ~$500K/year in donations, so an additional donation m between $0 and ~$100K would have <a href="https://www.wolframalpha.com/input/?i=plot%5B+%28m%2B500000%29%5E%28.8%29+-+%28500000%29%5E%28.8%29%2C+m%2C+0%2C+100000%5D">roughly linear</a> value with respect to m.

If you're splitting donations among causes like these, I suppose you could use leverage for those savings that you plan to give to organizations where the value of your donation is roughly linear and avoid it for those savings earmarked toward the more risk-averse charities. I don't know if there's a way to merge assets into a single pool with a mix of risk in between the two extremes. Splitting between some leveraged and some regular investments seems clear conceptually and easy to implement.

<h3>What about other donations you'll make later?</h3>

Modeling utility(wealth) = (wealth)<sup>&alpha;</sup> for only wealth earned over a only part of your life (say, a <REPLACE>years_until_donate</REPLACE>-year period) has a flaw: You'll probably donate more than this later on. Plus, maybe you have other savings not invested on margin that you'll donate as well. In this case, the total amount of your wealth is your current margin investments plus other amounts. In general, this should have the effect of implying that your current donations are actually farther along the utility(lifetime-donated wealth) curve than they seem and hence that marginal utility diminishes less sharply than you might think.((If utility(wealth) is (wealth)<sup>&alpha;</sup>, marginal utility at a given level of wealth is &alpha;(wealth)<sup>&alpha;-1</sup>, which is smaller as wealth is bigger.)) A hacky correction for this observation is to increase &alpha; relative to a naive estimate.

On the other hand, sometimes donation opportunities have time windows to them: If you don't donate within <REPLACE>years_until_donate</REPLACE> years, the project will either never happen or will be adequately funded by others. If this is the case, then only considering donations within a <REPLACE>years_until_donate</REPLACE>-year window is more correct, and other wealth that you might donate later doesn't enter into the analysis.

<h2>Margin simulations</h2>

I created a <a href="https://github.com/Brian-Tomasik/leveraged_investing">Python project</a> to simulate investing on margin. I'll present the results first and then describe its parameters and logic.

<h3>Results</h3>

The Mean, Median, Min, and Max columns of the following table are distributional statistics for the present value of wealth for the different strategies. The E[&radic;<span style="text-decoration: overline">wealth</span>] column represents expected utility if your utility is &radic;<span style="text-decoration: overline">wealth</span>; this helps incorporate <a href="http://reducing-suffering.org/when-should-altruists-be-financially-risk-averse/" title="&quot;When Should Altruists Be Financially Risk-Averse?&quot;">risk aversion</a>. Lastly, because the final wealth distribution is approximately lognormal, &sigma;<sub>ln(wealth)</sub> represents roughly the &sigma; parameter of the lognormal distribution.

<REPLACE>default_results_table</REPLACE>

<h4>Discussion</h4>

Since these results scale linearly with the amount of money being invested, the most relevant number is just the percent by which margin investing beats regular: The mean for margin is <REPLACE>margin_better_than_regular_percent</REPLACE>% higher, and the median is <REPLACE>margin_better_than_regular_median_percent</REPLACE>% higher.

If your altruistic utility(wealth) = &radic;<span style="text-decoration: overline">wealth</span>, then margin gives <REPLACE>margin_better_than_regular_expsqrtwealth_percent</REPLACE>% higher expected utility. To get a sense of how this expected-utility increase translates to real dollars, note that when utility(wealth) = &radic;<span style="text-decoration: overline">wealth</span>, a <REPLACE>margin_better_than_regular_expsqrtwealth_percent</REPLACE>% increase in expected utility is like a guaranteed <REPLACE>equiv_percent_increase_in_savings</REPLACE>% increase in invested savings because &radic;<span style="text-decoration: overline"><REPLACE>equiv_fractional_increase_in_savings_plus_1</REPLACE></span> = <REPLACE>fractional_increase_in_expsqrtwealth_plus_1</REPLACE>. The investor in this scenario starts out saving <REPLACE>initial_annual_income_for_investing</REPLACE>/year, so a <REPLACE>equiv_percent_increase_in_savings</REPLACE>% increase is as if you saved an extra <REPLACE>equiv_increase_in_savings</REPLACE>/year.

It's not clear that the extra hassle of margin investing is worth this increase in the expected utility of your donations. Margin investing requires rebalancing your account each month. Say this takes 20 hours/year, with your time valued at $50/hour. That's a cost of $1000/year for maintainence. There's also a one-time learning curve to understand margin investing in the first place and set up an Interactive Brokers account. Finally, the additional uncertainty of margin-invested returns may make planning more difficult for the charities to which you intend to donate, assuming they're counting on your future donations to some extent ahead of time.

Note that this analysis would be more favorable to margin investing if your utility was linear in wealth, such that you took the mean wealth numbers at face value. In this case, over the <REPLACE>years_until_donate</REPLACE> years of investing, using margin gave you <REPLACE>margin_better_than_regular</REPLACE> more expected donated wealth, or <REPLACE>margin_better_than_regular</REPLACE>/<REPLACE>years_until_donate</REPLACE> = <REPLACE>margin_better_than_regular_per_year</REPLACE> more per year. This seems more likely to be worth the cost of margin investing.<span style="color:orange">CHECK THIS MANUALLY</span>

So the basic conclusion is that margin investing is probably worthwhile only if the utility of additional donated dollars doesn't decline that much in possible worlds where you (and hence probably the market as a whole) make large returns compared with possible worlds where you (and hence probably the market as a whole) make smaller returns.

Here's how the expected utility of regular vs. margin investing compare if utility(wealth) = (wealth)<sup>&alpha;</sup> for 0 &leq; &alpha; &leq; 1:

<span class="fullwidthimage"><img src="<REPLACE>default_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

If we instead assumed that wealth had linear value up until some saturation point, after which it stopped being useful, we'd instead have this graph for expected saturation-utility:

<span class="fullwidthimage"><img src="<REPLACE>default_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Calculations of expected utility given some &alpha; parameter may be overly abstract, so it's also helpful to ground one's intuitions in a basic histogram of outcome possibilities. This graph shows the distribution of ending wealth for regular vs. margin investing. With which distribution of results would you be able to do more expected good via your donations?

<span class="fullwidthimage"><img src="<REPLACE>default_bothhist</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h4>Graphs of interest</h4>

Here are some individual trajectories of the two account types. We can see that margin usually underperforms regular.

<span class="fullwidthimage"><img src="<REPLACE>default_margin_sample_traj0</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>default_margin_sample_traj1</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>default_margin_sample_traj2</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>default_margin_sample_traj3</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>default_margin_sample_traj4</REPLACE>" title="I release this image into the public domain worldwide." /></span>

The next chart shows (real present value) wealth trajectories for the first 20 individual runs of the simulation. Each colored line is one history of the investor under some configuration of market performance and unemployment outcomes.

<span class="fullwidthimage"><img src="<REPLACE>default_wealthtraj</REPLACE>" title="I release this image into the public domain worldwide." /></span>

An investor's margin-to-assets ratio is debt/(total securities value). For example, if you start with $5 and borrow another $5 to buy $10 of an ETF, your margin is $5 and assets are $10, giving a margin-to-assets ratio of .5. The following graph shows the average progression of the simulated investors' margin-to-assets ratios over time. .<REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE> is the target leverage when buying new securities. The decrease over time occurs because the securities tend to increase in value, which creates more assets for the same amount of debt.

<span class="fullwidthimage"><img src="<REPLACE>default_avgMTA</REPLACE>" title="I release this image into the public domain worldwide." /></span>

And this graph shows individual trajectories for the first 20 random investors' margin-to-assets ratios.

<span class="fullwidthimage"><img src="<REPLACE>default_indMTA</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Since the investor sells the biggest capital losses, both for tax-loss harvesting and when she needs money for rebalancing, she accumulates capital losses over time, of which she can deduct $3K per year from income taxes. Following are the first 20 random trajectories of how much capital loss is accumulated over time:

<span class="fullwidthimage"><img src="<REPLACE>default_carrcg</REPLACE>" title="I release this image into the public domain worldwide." /></span>

This next graph shows how much the actual simulated margin-account values deviate from what one would compute using a very simple constant-leverage calculation, for the first few individual trajectories of the simulation. The graph serves two purposes:
<ol>
<li>verifying that the complex simulation isn't going too far awry due to undiscovered bugs</li>
<li>showing how much difference the complexities of the simulation make to the overall result.</li>
</ol>
I only needed to plot margin-account values because non-margin-account values perfectly match a simple calculation.

<span class="fullwidthimage"><img src="<REPLACE>default_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Based on how small these differences usually are, it looks like I probably could have made my simulation a lot simpler without much loss of accuracy! But it's already written, so I'm using it.

<h3>Input parameters for these results:</h3>

The following parameters are what I refer to as the "default" setting in the rest of this essay:
<ul>
<li>invest for <REPLACE>years_until_donate</REPLACE> years before donating</li>
<li>savings are <REPLACE>initial_annual_income_for_investing</REPLACE>/year in the first year, with <REPLACE>annual_real_income_growth_percent</REPLACE>% real annual growth (i.e., after <REPLACE>years_until_donate</REPLACE> years, inflation-adjusted savings are about <REPLACE>yearly_income_at_end_of_investing_period</REPLACE>/year), with a slight penalty the more times the person is laid off</li>
<li>starting emergency money, which gets invested without leverage = <REPLACE>initial_emergency_savings</REPLACE></li>
<li>short-term capital-gains tax rate = <REPLACE>short_term_cap_gains_rate</REPLACE></li>
<li>long-term capital-gains tax rate = <REPLACE>long_term_cap_gains_rate</REPLACE></li>
<li>state income-tax rate (whether short-term or long-term gains) = <REPLACE>state_income_tax</REPLACE></li>
<li>monthly probability of being laid off = <REPLACE>monthly_probability_of_layoff</REPLACE></li>
<li>monthly probability of finding work after being laid off = <REPLACE>monthly_probability_find_work_after_laid_off</REPLACE></li>
<li>average annual returns (continuously compounded) of index ETF = <REPLACE>annual_mu_as_percent</REPLACE> (This assumes a return of <a href="http://www.marketwatch.com/story/stocks-future-return-just-56-annualized-2012-09-21" title="&quot;Stocks future return: Just 5.6% annualized&quot;">5.6%</a> not continuously compounded, since ln(1 + 0.056) = 0.054. This estimate is conservative, since historical returns have been more like ~10% in the USA. The reason to use continuous interest is that stock prices are compounded daily <REPLACE>trading_days_per_year</REPLACE> times per year, so the return is approximately continuously compounded anyway. To see this, note that (1+ln(1.056)/<REPLACE>trading_days_per_year</REPLACE>)<sup><REPLACE>trading_days_per_year</REPLACE></sup> &asymp; 1.056.)<!--I THINK MY LN(1.056) = .054 THING MIGHT BE MISGUIDED. I don't use continuously compounded returns after fixing the bug?? Oh no, I do. :) because a daily mu of .054 is like a yearly mu of .056 :)--></li>
<li>annual volatility of index ETF = <REPLACE>annual_sigma_as_percent</REPLACE> (I <a href="https://docs.google.com/spreadsheets/d/1g2B0vZwePiaJ0ypqTqe_jheLBF25qNRtb-H2eoDcNik/edit#gid=0">calculated</a> this based on <a href="http://finance.yahoo.com/q?s=SPY">SPY</a> data from 3 Jan. 2007 to 2 Apr. 2015. You could also <a href="http://www.indexologyblog.com/2014/02/04/whats-a-normal-vix-level/" title="&quot;Whats a Normal VIX Level?&quot;">look</a> at the <a href="https://en.wikipedia.org/wiki/VIX">VIX index</a>. I don't recommend investing in the US stock market at the moment because some think it's overpriced. I picked a random global index ETF, ACWI, and found that it had annual volatility of 0.24 between 28 Mar. 2008 to 1 May 2015. It <a href="https://www.ishares.com/us/products/239600/ishares-msci-acwi-etf" title="'iShares MSCI ACWI ETF'">has</a> about 50% holdings in the USA. It would be good to look at volatility for other types of index ETFs too.)</li>
<li>"medium black swan" probability = <REPLACE>medium_black_swan_prob</REPLACE></li>
<li>annual volatility for "medium black swan" event = <REPLACE>annual_sigma_for_medium_black_swan</REPLACE></li>
<li>"large black swan" probability = <REPLACE>large_black_swan_prob</REPLACE></li>
<li>annual volatility for "large black swan" event = <REPLACE>annual_sigma_for_large_black_swan</REPLACE></li>
<li>trading days per year = <REPLACE>trading_days_per_year</REPLACE></li>
<li>margin interest rate = <REPLACE>annual_margin_interest_rate_as_percent</REPLACE> (The actual current margin rate on Interactive Brokers <a href="https://www.interactivebrokers.com/en/index.php?f=interest&p=schedule2" title="&quot;Interest Rates Charged to You on Margin Loan Balances&quot;">is</a> 1.12% for account balances of at least $100K and less than $1M. I chose a higher value of <REPLACE>annual_margin_interest_rate_as_percent</REPLACE> to make the calculations more conservative and because current interest rates are extremely low by <a href="http://www.macrotrends.net/1433/historical-libor-rates-chart" title="&quot;Historical LIBOR Rates Chart&quot;">historical standards</a>, which is a trend that may not last for <REPLACE>years_until_donate</REPLACE> more years. The effective margin interest rate is also lower if you deduct margin interest payments against other net investment income. To keep things conservative, I ignore this point, since you may not have much other net investment income. If you're buy-and-hold investing to donate appreciated securities, the only investment income you'd have would be from dividends, not from capital gains.)</li>
<li>inflation rate = <REPLACE>inflation_rate_as_percent</REPLACE> (see p. 5 of <a href="http://reducing-suffering.org/wp-content/uploads/2014/09/donatable-money.pdf" title="&quot;How Much Money Could a Person Donate by Having a Conventional Job?&quot;">this piece</a>)</li>
<li>broker-imposed max margin-to-assets ratio in your margin account = <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>% (For simplicity, I'm not distinguishing initial margin vs. maintenance margin.)</li>
<li>voluntarily self-imposed max margin-to-assets ratio in the account = <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% (monthly rebalancing to keep margin below this ratio)</li>
<li>trading fee per dollar of securities bought or sold = $<REPLACE>fee_per_dollar_traded</REPLACE> (this counts both Interactive Brokers trading fees and bid-ask spreads)</li>
<li>number of random iterations = <REPLACE>num_trials</REPLACE></li><span style="color:orange">This often gets messed up</span>
</ul>

<h4>Explanation of "black swan" probabilities</h4>

Simple stock-market models typically use geometric Brownian motion. This is fine for some purposes, but when considering long-term leverage investing, the <a href="https://en.wikipedia.org/wiki/Fat-tailed_distribution">fat tails</a> of actual financial distributions become important. "<a href="http://www.investmentreview.com/files/2009/12/leveraged_portfolios1.pdf">Leveraged Canadian Stock Portfolios: Long-Run Effects on Wealth and Risk</a>" notes that a 4X leverage strategy would have done badly between 1950 and 2001. One reason was <a href="https://en.wikipedia.org/wiki/Black_Monday_(1987)">1987's Black Monday</a>, which would have almost wiped out the whole margin account balance due to a <i>one-day</i> loss of ~23%. (Even end-of-day rebalancing wouldn't have been able to prevent losing almost all account value.) Clearly, "<a href="https://en.wikipedia.org/wiki/Black_swan_theory">black swan</a>" events like these can make a big difference to the final analysis.

The parameters of my normal distribution are &mu; = <REPLACE>annual_mu</REPLACE> and &sigma; = <REPLACE>annual_sigma</REPLACE>. Consider a one-day market movement. Assuming <REPLACE>trading_days_per_year</REPLACE> trading days per year, the expected daily movement is <REPLACE>annual_mu</REPLACE>/<REPLACE>trading_days_per_year</REPLACE> = <REPLACE>annual_mu/trading_days_per_year</REPLACE>, and the standard deviation is <REPLACE>annual_sigma</REPLACE> / &radic;<span style="text-decoration: overline"><REPLACE>trading_days_per_year</REPLACE></span> = <REPLACE>annual_sigma/sqrt(trading_days_per_year)</REPLACE>. Since the standard deviation is so much bigger than the mean, let's just focus on the standard deviation and assume a mean of 0.

A loss of 23% in a single day (Black Monday) means multiplying previous prices by (1-0.23). Since geometric Brownian motion implies continuous compounding, we should convert this to a continuous rate. We want a change C such that exp(C) = 1-0.23, which means C = ln(1-0.23) = -0.26. This is a daily return that should be able to be sampled from our distribution of daily returns -- the distribution with a mean of (roughly) 0 and a standard deviation of 0.014. But the <a href="https://en.wikipedia.org/wiki/Standard_score">z-value</a> for a -0.26 return is -0.26/.014 = -19, which has a probability so small that online normal-distribution calculators can't handle it. Basically, this event should have never happened. But it did once over the 51-year period from 1950 to 2001. This needs to be addressed in the simulations or else they risk ignoring huge risk from black swans.

There are many proposals for modeling fat-tailed distributions in finance. To keep things simple, I chose a finite mixture of normal distributions (see section 6.3 of <a href="http://ect-pigorsch.mee.uni-bonn.de/data/research/papers/Financial_Economics,_Fat-tailed_Distributions.pdf" title="&quot;Financial Economics, Fat-tailed Distributions&quot;">this paper</a>). I estimated the parameters by hand in a quick-and-dirty way as described below, but of course it would help to use more systematically determined parameters, as well as to try other fat-tailed distributions.

Also note that there's a bit of double counting in that for non-black-swan days, I'm using a volatility estimate based on long-run daily-return data, which include some highly volatile periods. Ideally I would exclude the black swans from the data when calculating the non-black-swan mean and variance, but I assume the difference this would make is small, and neglecting to do it just makes the calculations more cautious.

I looked at Wikipedia's "List of largest daily changes in the Dow Jones Industrial Average", focusing on the <a href="https://en.wikipedia.org/wiki/List_of_largest_daily_changes_in_the_Dow_Jones_Industrial_Average#Largest_percentage_changes">largest percentage changes</a>. The dates go back to 1898. The range from 1898 to 2014 is 116 years. Multiplying by <REPLACE>trading_days_per_year</REPLACE> trading days per year, that's roughly 30,000 days. I copied the changes into <a href="https://docs.google.com/spreadsheets/d/1-jeD5_jiHmhGhP-uMoDwI153ZibLBBfGr3Kgn7PgvPo/edit#gid=0" title="&quot;Quick-and-dirty black-swans calculation&quot;">a spreadsheet</a> and computed the equivalent continuous-compounding daily returns.

Except for Black Monday, the returns are relatively uniform, but a normal approximation will do. The standard deviation of the 39 returns excluding Black Monday is about 0.09, but this estimate is inflated because my data set includes numbers like -0.07 and +0.07 but no numbers like -0.02, 0, or +0.02 (i.e., the middle of the distribution is empty). Instead, I estimated the standard deviation by eye. The numbers with the smallest magnitudes in the data set are about -0.07 and +0.07. Say that's one standard deviation from an assumed mean of 0. Then -0.14 and +0.14 would be two standard deviations from 0. Observations that extreme or more should occur 5% of the time, and indeed, we see two data points out of the 39 that are roughly 0.14 in magnitude. Now, the 39 numbers are missing data within one standard deviation of 0. About 68% of observations fall within one standard deviation of the mean. So we can assume that the 39 data points correspond to 100%-68% = 32% of all instances of returns drawn from this distribution. In other words, we can imagine there were 39/.32 = 122 events drawn from this distribution in total, out of 30,000 total days. So the probability that a given daily return will be drawn from this distribution out of the mixture of normals is 122/30,000 = 0.004. Finally, note that the standard deviation of 0.07 is for one day, which means the annualized volatility would be 0.07 * &radic;<span style="text-decoration: overline"><REPLACE>trading_days_per_year</REPLACE></span> = 1.1. These are the parameters I used for medium-scale black swans.

Now to handle Black Monday. Suppose that it was 1 standard deviation from the mean of a large-scale black swan distribution. That implies the daily volatility for this distribution is 0.26, which annualizes to 0.26 * &radic;<span style="text-decoration: overline"><REPLACE>trading_days_per_year</REPLACE></span> = 4.1. It happened once in 30,000 days, so the probability of drawing from this distribution is 0.00003. To make the calculations more conservative and help account for black-swan changes more extreme than anything we've seen before, increase the probability threefold to 0.0001. In other words, the probability that a <REPLACE>years_until_donate</REPLACE>-year investing period hits at least one such event is 1-Prob(hit zero of them) = 1-0.9999<sup>(<REPLACE>years_until_donate</REPLACE> * <REPLACE>trading_days_per_year</REPLACE>)</sup> = <REPLACE>prob_at_least_1_big_black_swan</REPLACE>.

I implemented the mixture of normal distributions by picking a random floating-point number between 0 and 1. If it was <.0001, I used the extreme black-swan distribution. If it was between 0.0001 and 0.0041, I used the medium black-swan distribution. Otherwise I used the default normal distribution.

<h3>How the simulation works</h3>

I compare investing in a regular brokerage account vs. buying on margin. In both cases, I assume you only buy a single index ETF.((Buying an index fund instead of individual stocks diversifies investments. Diversification is suggested by "<a href="http://www.mathisen.ca/leveraging/leveraging.pdf">Understanding Investment Leverage</a>", p. 8, item #5. That said, I would guess that buying some individual stocks would be almost as diversified, so that seems like a viable alternative to an index ETF.)) Its price updates every weekday. You get paid every month and use that new income for investing. If you have a margin account, you also pay interest on it every month, on your pay day.

Most of the time you're earning money, but occasionally, at random, you might get laid off. I incorporated this aspect of the simulation to make calculations more conservative. The idea came from <a href="http://www.michaeljamesonmoney.com/2012/03/lifecycle-investing-leveraged-strategy.html" title="&quot;Lifecycle Investing  a Leveraged Strategy&quot;">this post</a>. In fact, that post suggests that layoffs are more likely during market downturns, but for simplicity, I made layoffs just random.

If you use a regular brokerage account, then every month when you're not laid off, you just use your new income to buy more of the index ETF. End of story.

If you use a margin account, your actions are a bit more complex. With the money that you earn when you're not laid off:
<ol>
<li>First you pay whatever interest is due on your margin borrowing from prior months, using the new savings that you're depositing. (If you don't have enough income this month to cover interest, you sell some of your investments to pay the interest. In the simulations I've run, this only happens when you get laid off.)</li>
<li>You check the margin-to-assets ratio in your margin account. If it's below <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% (i.e., <REPLACE>initial_personal_max_margin_to_assets_relative_to_broker_max_as_percent</REPLACE>% of the broker-required <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>% ratio), you leave the account alone. If the margin-to-assets ratio is above <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>%, you first pay for it with that month's paycheck, and if that's not enough, you sell some investments to bring the ratio back down to <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>%. It may be best not to do this too much because selling investments can incur capital-gains tax.<!--I DON'T THINK THIS IS TRUE ANYMORE, SINCE LEVERAGED ETFS HAVE HIGHER EV: Another possible reason why frequent rebalancing might be bad is if it produces similar behavior as happens with leveraged ETFs, though I haven't figured out the math of whether this is actually true.--> That said, one of two cases where your margin-to-assets ratio gets above <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% is when the market underperforms the interest rate, which means you tend to have capital losses and so get some tax benefit from selling. The program chooses the most tax-advantaged lots of your portfolio to sell, based on which, if sold, would trigger the least capital-gains tax (which includes the biggest negative capital-gains tax if you have losses). The other case where your margin-to-assets ratio might get too big is if you're laid off for more than a brief period, so that interest payments pile up.</li>
<li>If you have any monthly income left over after the previous steps, use it to buy new shares of the index ETF at a margin-to-assets ratio of <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>%, i.e., for every $100 of shares you buy directly, you also loan $<REPLACE>example_loan_to_take_for_100_of_shares_equity</REPLACE> to buy more shares on margin. This is because <REPLACE>example_loan_to_take_for_100_of_shares_equity</REPLACE> / (<REPLACE>example_loan_to_take_for_100_of_shares_equity</REPLACE> + 100) = .<REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>.</li>
<li>If your margin-to-assets ratio is below our target (<REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>%), then buy new securities to reach your target. In order to avoid incurring transactions costs on trivially small equity purchases, you only buy new ETF shares for rebalancing if you can buy at least $<REPLACE>min_additional_purchase_amount</REPLACE> of such shares at once.</li>
</ol>
As you move toward your target date for donating the securities, you ramp down leverage to make sure you'll have enough equity to pay off your debts. This ramp-down basically doesn't affect the default scenario of 2X leverage, but for higher leverage amounts, it forces you to drop down to being within 3X leverage when there are at most 10 years left and within 2X leverage when there are at most 5 years left.

You maintain a self-imposed maximum margin-to-assets ratio of <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% to give some breathing room relative to the broker-imposed maximum margin-to-assets ratio of <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>%. In the simulation, the broker checks the margin-to-assets ratio every weekday and, if it's above <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>%, sells securities randomly to keep the ratio within bounds. But this is bad for you, since it leads to unpredictable selling behavior. For instance, maybe the broker sells securities with high, short-term capital gains rather than those with capital losses. It's better if you can personally keep margin-to-assets ratios in check by selling securities manually as needed. But you don't want to manage the account daily, so you monthly keep the margin-to-assets ratio less than <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>%, on the assumption that the ratio won't move above <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>% within the next month. Adopting this policy reduces manual maintenance work. It's much easier to check a margin account 12 times a year than <REPLACE>trading_days_per_year</REPLACE> times a year, and the lost leverage by maintaining a maximum <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% ratio instead of <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>% isn't that big.

Different variations of a margin strategy sell securities at different rates. The more leveraged you are, the more likely you are to sell securities at a loss to meet margin requirements. This means some strategies get more tax benefit from capital losses than others. To help put the strategies on somewhat more even footing, I added tax-loss harvesting, which is done by both margin and regular investors every December: You sell all securities with losses and use the money to buy the sold ETF back. (In real life, you'd have to wait a month before buying back to avoid a <a href="https://en.wikipedia.org/wiki/Wash_sale">wash sale</a>, but in the simulation you buy it back immediately for simplicity.)

Your capital-gains taxes accumulate from selling, both for tax-loss harvesting and for rebalancing your margin account as needed. Every March 1, you pay off any taxes owed, if necessary by selling some securities. However, almost uniformly you have net capital losses, because basically the only times you might sell securities at a capital gain are (1) if the broker liquidates them to keep you within the <REPLACE>broker_max_margin_to_assets_ratio_as_percent</REPLACE>% margin limit or (2) if you're unemployed for a while and have to sell ETF shares with gains.

The simulation assumes the investor starts off with emergency funds that are only invested without leverage. Having emergency funds makes sense in case you need money urgently after your margin account has gone bust. Some possible reasons why you might need money urgently:
<ul>
<li>you get laid off for a while</li>
<li>a parent, spouse, friend, etc. needs a big loan urgently</li>
<li>you want to quit your job early and don't have enough in your 401k to retire on</li>
<li>you come across an altruistic project that requires donations now or never and has such high value that you can't afford not to donate immediately.</li>
</ul>
The invested value of emergency funds is counted as part of your total invested money at the end of the simulation. I count the emergency money toward your total donation amount, which would make sense if the end of the simulation corresponds to your retirement, at which point you can donate the emergency funds and live off your 401k.

In rare cases, such as when a big negative black swan occurs, highly leveraged accounts might get wiped out due to having more debt than remaining assets. If that happens, you tap into your emergency savings. There are two possibilities:
<ol>
<li>If emergency savings are enough to pay off the shortfall, then you pay off your debts. Then with future salary, you restore your emergency fund until it's equal with what it would have been had you not invested on margin. After that, you continue margin investing as usual.</li>
<li>If even emergency savings can't cover the shortfall, you pay off what you can and go completely broke, declaring bankruptcy to eliminate your debts. After that, I assume that your ability to get credit is so bad that you can't invest on margin anymore (I'm not sure if this is true in practice??), so you just invest future earnings in regular equities without leverage thereafter.</li>
</ol>

When you're ready to donate your securities, you use your investments to pay off any remaining margin loans. Because you're donating the final securities, there's no capital-gains tax on them. If instead you use this calculator for personal investing (say, for retirement) rather than investing prior to donating, then you'd need to account for capital-gains tax upon selling. (In that case, it's less bad to pay capital-gains taxes early because doing so increases your cost basis, though it's still better to delay tax payments to later years because of the <a href="https://en.wikipedia.org/wiki/Time_value_of_money">time value of money</a>.)

The final comparison among the strategies as presented in the results is the real present value of accumulated savings, i.e., the value after <REPLACE>years_until_donate</REPLACE> years times (1 + inflation_rate)<sup>-<REPLACE>years_until_donate</REPLACE></sup> to adjust for inflation and then times exp(-avg_ETF_returns * <REPLACE>years_until_donate</REPLACE>)</sup> to make it a present value. Looking at real present values is more informative than nominal future values because we have a better sense of what the value of a dollar is right now than what the value of a dollar will be in <REPLACE>years_until_donate</REPLACE> years.

<h3>Results vs. theory</h3>

<span style="color:red">ADD COMPARISON OF THEORETICAL LEVERAGED RESULTS VS. ACTUAL</span>

The simulation discussed above has many real-world complexities. Theoretical academic formulas for margin returns are much simpler. As a way to check that my complicated simulation was roughly on the right track, I ran a version of the simulation in which lots of complicating factors were ignored. In particular:
<ul>
<li>no unemployment, inflation, taxes, black swans, or emergency funds</li>
<li>the investor gets paid on only one occasion -- namely, her first pay period right when the simulation starts</li>
<li>the investor rebalances monthly toward a leverage ratio exactly equal to the broker-imposed leverage limit rather than comfortably under that limit as in the default scenario</li>
<li>the investor doesn't taper off leverage toward the end of the investing period.</li>
</ul>
Following are the results with this much simpler version of the simulation:

<REPLACE>closetotheory_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_bothhist</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_margin_sample_traj0</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_margin_sample_traj1</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_margin_sample_traj2</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_margin_sample_traj3</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_margin_sample_traj4</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

I compare these numbers with theory below.
<!--
the final price S<sub>t</sub> of a security S after t years <a href="http://www.columbia.edu/~ks20/FE-Notes/4700-07-Notes-GBM.pdf" title="&quot;Geometric Brownian motion&quot;">is</a> the initial price, S<sub>0</sub>, times exp(X<sub>t</sub>), where X<sub>t</sub> is a Brownian motion with annual drift &mu; and variance &sigma;<sup>2</sup>. Since X<sub>t</sub> is normally distributed, S<sub>t</sub>/S<sub>0</sub> = exp(X<sub>t</sub>) is lognormally distributed, i.e., ln(S<sub>t</sub>/S<sub>0</sub>) is normally distributed with mean &mu;t and variance &sigma;<sup>2</sup>t. For a <a href="https://en.wikipedia.org/wiki/Log-normal_distribution">lognormal distribution</a>, the median is exp(&mu;t), and the mean is exp(&mu;t + &sigma;<sup>2</sup>t/2). Hence, the median final value of wealth from investing should be S<sub>0</sub> exp(&mu;t), and the mean final value should be S<sub>0</sub> exp(&mu;t + &sigma;<sup>2</sup>t/2). For more explanation, see <a href="https://books.google.com/books?id=DFJg_3PJ5ToC&pg=PA83&lpg=PA83&dq=%22geometric+brownian+motion%22+median&source=bl&ots=arNDISdxak&sig=wT1rLUBmWkHDqt2EmCBAw5KYOg8&hl=en&sa=X&ei=GFQ-Vb3fMNa1sQSv4YGwAw&ved=0CD0Q6AEwBA#v=onepage&q=%22geometric%20brownian%20motion%22%20median&f=false" title="'Statistics and Finance: An Introduction' by David Ruppert, p. 83">here</a>.
USED TO BE A FOOTNOTE:<begin footnote>I'm still confused about something. If you have insights, let me know.

On the one hand, since X<sub>t</sub> is normal with mean &mu;t and variance &sigma;<sup>2</sup>t, S<sub>t</sub> = S<sub>0</sub> exp(X<sub>t</sub>) is lognormal with mean S<sub>0</sub> exp(&mu;t + &sigma;<sup>2</sup>t/2). This is a basic fact about a lognormal distribution. And when I compare predictions with this formula against my actual results, the match is very good.

On the other hand, consider the <a href="https://en.wikipedia.org/wiki/Geometric_Brownian_motion#Technical_definition:_the_SDE">geometric Brownian motion stochastic differential equation</a> (SDE):
<blockquote>
&part;S<sub>t</sub>/S<sub>t</sub> = &mu; &part;t + &sigma; &part;W<sub>t</sub>.
</blockquote>
This seems to be what I'm using in my simulation (modulo the fact that my simulation has a granularity of a day at a time, not the infinitesimal granularity of the above continuous-time SDE). Solving this SDE <a href="https://en.wikipedia.org/wiki/Geometric_Brownian_motion#Solving_the_SDE">tells us</a> that S<sub>t</sub> is not actually S<sub>0</sub> exp(X<sub>t</sub>) but is instead S<sub>0</sub> exp(X<sub>t</sub> - &sigma;<sup>2</sup>t/2). Then, because of how expectations work for lognormal distributions, <a href="https://en.wikipedia.org/wiki/Geometric_Brownian_motion#Properties">we have that</a> E[S<sub>t</sub>] = S<sub>0</sub> exp(&mu;t). The -&sigma;<sup>2</sup>t/2 cancelled with a +&sigma;<sup>2</sup>t/2. However, this formula doesn't agree with my simulation results. Why not?<end footnote>
-->
<h4>Validating the results of regular investing</h4>

<h5>Median wealth</h5>

The theoretical median outcome for regular investing is shown in the <a href="#regular_median">regular median equation</a>. However, when I reported my numbers in this simulation, I discounted final wealth using <a href="https://en.wikipedia.org/wiki/Compound_interest#Continuous_compounding">continuous compounding</a> at a discount rate of &mu; = <REPLACE>annual_mu</REPLACE> per year over a time of t = <REPLACE>years_until_donate</REPLACE> years. That is, I multiplied the final amounts by exp(- <REPLACE>annual_mu</REPLACE> * <REPLACE>years_until_donate</REPLACE>). Multiplying the <a href="#regular_median">regular median equation</a> by this factor gives S<sub>0</sub> exp(&mu;t - &sigma;<sup>2</sup>t/2) exp(-&mu;t) = S<sub>0</sub> exp(-&sigma;<sup>2</sup>t/2). This is what we predict the median simulation outcome will be.

In the simulation, I used t = <REPLACE>years_until_donate</REPLACE> years, &mu; = <REPLACE>annual_mu</REPLACE> per year, &sigma; = <REPLACE>annual_sigma</REPLACE>, and S<sub>0</sub> = <REPLACE>one_month_pay</REPLACE>.<!-- There's not actually a single initial price S<sub>0</sub> because the securities are bought over time. However, we can pretend that the investor buys just one big initial security whose price equals the present value of purchases discounted at an interest rate of <REPLACE>annual_mu_as_percent</REPLACE>. An analytic formula for this discounted sum is messy, so I just computed it <a href="https://docs.google.com/spreadsheets/d/1STH-QEMwybDKrouTnNEWeXQXU9VK1SEmq_qNxPCdUTc/edit?usp=sharing">in a spreadsheet</a>. If we ignore periods of unemployment and inflation, the result is that S<sub>0</sub> = <REPLACE>one_month_pay</REPLACE>.--> The empirical median from the above table, <REPLACE>actual_median_ignoring_complications</REPLACE>, is very close to<span style="color:orange">CHECK THIS MANUALLY</span> the theoretical value, <REPLACE>one_month_pay</REPLACE> exp(-<REPLACE>annual_sigma</REPLACE><sup>2</sup> * <REPLACE>years_until_donate</REPLACE>/2) = <REPLACE>theoretical_median_PV_ignoring_complications</REPLACE>.

<h5>Mean wealth</h5>

We found the theoretical mean above in <a href="#regular_mean">regular mean equation</a>. When discounted, it becomes S<sub>0</sub> exp(&mu;t) exp(-&mu;t) = S<sub>0</sub>, i.e., just the initial price. So the theoretical mean is just the initial amount invested: <REPLACE>one_month_pay</REPLACE>. The empirical mean value from the above table is <REPLACE>actual_mean_ignoring_complications</REPLACE>.

<h5>Std dev of log wealth</h5>

If we take ln of both sides of the <a href="#regular_S_t">regular S<sub>t</sub> equation</a>, we get
<blockquote>
ln(S<sub>t</sub>) = ln(S<sub>0</sub>) + &mu;t - &sigma;<sup>2</sup>t/2 + &sigma;W<sub>t</sub>.
</blockquote>
The only randomness here is in W<sub>t</sub>, so
<blockquote>
StdDev[ln(S<sub>t</sub>)] = StdDev[&sigma;W<sub>t</sub>] = &sigma;StdDev[W<sub>t</sub>] = &sigma;&radic;<span style="text-decoration: overline">t</span> = <REPLACE>annual_sigma</REPLACE> * &radic;<span style="text-decoration: overline"><REPLACE>years_until_donate</REPLACE></span> = <REPLACE>annual_sigma * sqrt(years_until_donate)</REPLACE>.
</blockquote>
In the simulations, I found StdDev[ln(S<sub>t</sub>)] = &sigma;<sub>ln(wealth)</sub> = <REPLACE>actual_sigma_of_log_wealth</REPLACE> for regular investing, which is again pretty close.<span style="color:orange">CHECK THIS MANUALLY</span>

<h4>Validating the results of margin investing</h4>

<h5>Median wealth</h5>

Discounting the <a href="#leveraged_median">leveraged median equation</a>:
<ul>
<li>Theoretical discounted median = V<sub>0</sub> exp{(r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2} exp(-&mu;t) = V<sub>0</sub> exp{(rt + &mu;ct - &mu;t - rct - c<sup>2</sup>&sigma;<sup>2</sup>t/2} = V<sub>0</sub> exp{&mu;(c-1)t - r(c-1)t - c<sup>2</sup>&sigma;<sup>2</sup>t/2} = V<sub>0</sub> exp{(&mu;-r)(c-1)t - c<sup>2</sup>&sigma;<sup>2</sup>t/2} = <REPLACE>one_month_pay</REPLACE> * exp{(<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>) * (<REPLACE>broker_imposed_leverage_limit</REPLACE>-1) * <REPLACE>years_until_donate</REPLACE> - <REPLACE>broker_imposed_leverage_limit</REPLACE><sup>2</sup> * <REPLACE>annual_sigma</REPLACE><sup>2</sup> * <REPLACE>years_until_donate</REPLACE>/2} = <REPLACE>leveraged_theoretical_median_PV_ignoring_complications</REPLACE></li>
<li>Empirical discounted median = <REPLACE>leveraged_actual_median_ignoring_complications</REPLACE></li>
</ul>

<h5>Mean wealth</h5>

Discounting the <a href="#leveraged_mean">leveraged mean equation</a>:
<ul>
<li>Theoretical discounted mean = V<sub>0</sub> exp{(r + (&mu;-r)c) t} exp(-&mu;t) = V<sub>0</sub> exp{rt + &mu;ct - &mu;t - rct} = V<sub>0</sub> exp{&mu;(c-1)t - r(c-1)t} = V<sub>0</sub> exp{(&mu;-r)(c-1)t} = <REPLACE>one_month_pay</REPLACE> * exp{(<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>) * (<REPLACE>broker_imposed_leverage_limit</REPLACE>-1) * <REPLACE>years_until_donate</REPLACE>} = <REPLACE>leveraged_theoretical_mean_PV_ignoring_complications</REPLACE></li>
<li>Empirical discounted mean = <REPLACE>leveraged_actual_mean_ignoring_complications</REPLACE></li>
</ul>

<h5>Std dev of log wealth</h5>

Taking ln of both sides of the <a href="#leveraged_V_t">leveraged V<sub>t</sub> equation</a>:
<blockquote>
ln(V<sub>t</sub>) = ln(V<sub>0</sub>) + (r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c&sigma;W<sub>t</sub>.
</blockquote>
The only randomness here is in W<sub>t</sub>, so
<blockquote>
StdDev[ln(V<sub>t</sub>)] = StdDev[c&sigma;W<sub>t</sub>] = c&sigma;StdDev[W<sub>t</sub>] = c&sigma;&radic;<span style="text-decoration: overline">t</span> = <REPLACE>broker_imposed_leverage_limit</REPLACE> * <REPLACE>annual_sigma</REPLACE> * &radic;<span style="text-decoration: overline"><REPLACE>years_until_donate</REPLACE></span> = <REPLACE>leveraged_theoretical_sigma_ln_wealth</REPLACE>.
</blockquote>

The empirical value of &sigma;<sub>ln(wealth)</sub> for margin investing in the above table was <REPLACE>leveraged_actual_sigma_of_log_wealth</REPLACE>.

<h4>Prob[margin beats regular]</h4>

We want to know the probability that margin investing does better than regular, Prob[V<sub>t</sub> > S<sub>t</sub>], on the same underlying asset trajectory. Assume both portfolios start out with equal initial capital: V<sub>0</sub> = S<sub>0</sub> = K. Then, using the <a href="#regular_S_t">regular S<sub>t</sub> equation</a> and <a href="#leveraged_V_t">leveraged V<sub>t</sub> equation</a>:
<blockquote>
Prob[V<sub>t</sub> > S<sub>t</sub>] = Prob[ln(V<sub>t</sub>) > ln(S<sub>t</sub>)]<br />
= Prob[ln(K) + (r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c&sigma;W<sub>t</sub> > ln(K) + &mu;t - &sigma;<sup>2</sup>t/2 + &sigma;W<sub>t</sub>]<br />
= Prob[(r + (&mu;-r)c) t - (c<sup>2</sup>-1)&sigma;<sup>2</sup>t/2 + (c-1)&sigma;W<sub>t</sub> > &mu;t]<br />
= Prob[r + (&mu;-r)c - (c<sup>2</sup>-1)&sigma;<sup>2</sup>/2 + (c-1)&sigma;W<sub>t</sub>/t > &mu;]<br />
= Prob[(1-c)r + &mu;(c-1) - (c<sup>2</sup>-1)&sigma;<sup>2</sup>/2 + (c-1)&sigma;W<sub>t</sub>/t > 0]<br />
= Prob[(&mu;-r)(c-1) - (c<sup>2</sup>-1)&sigma;<sup>2</sup>/2 + (c-1)&sigma;W<sub>t</sub>/t > 0]<br />
= Prob[(c-1)&sigma;W<sub>t</sub>/t > (c<sup>2</sup>-1)&sigma;<sup>2</sup>/2 - (&mu;-r)(c-1)]<br />
= Prob[(c-1)&sigma;W<sub>t</sub>/t > (c-1)(c+1)&sigma;<sup>2</sup>/2 - (&mu;-r)(c-1)]<br />
= Prob[&sigma;W<sub>t</sub>/t > (c+1)&sigma;<sup>2</sup>/2 - (&mu;-r)]<br />
= Prob[W<sub>t</sub>/t > (c+1)&sigma;/2 - (&mu;-r)/&sigma;].
</blockquote>
Now recall that if Z is a standard-normal random variable, W<sub>t</sub> = Z&radic;<span style="text-decoration: overline">t</span>. Substituting in:
<blockquote>
Prob[V<sub>t</sub> > S<sub>t</sub>] = Prob[Z/&radic;<span style="text-decoration: overline">t</span> > (c+1)&sigma;/2 - (&mu;-r)/&sigma;]<br />
= Prob[Z > &radic;<span style="text-decoration: overline">t</span>( (c+1)&sigma;/2 - (&mu;-r)/&sigma; )]<br />
= 1 - Prob[Z &leq; &radic;<span style="text-decoration: overline">t</span>( (c+1)&sigma;/2 - (&mu;-r)/&sigma; )]<br />
= 1 - Prob[Z &leq; &radic;<span style="text-decoration: overline"><REPLACE>years_until_donate</REPLACE></span>( (<REPLACE>broker_imposed_leverage_limit</REPLACE>+1)<REPLACE>annual_sigma</REPLACE>/2 - (<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)/<REPLACE>annual_sigma</REPLACE> )]<br />
= 1 - Prob[&nbsp;Z &le; <REPLACE>Z_value_threshold</REPLACE>&nbsp;]<br />
<a href="https://surfstat.anu.edu.au/surfstat-home/tables/normal.php" title="&quot;SurfStat standard normal calculator&quot;">= 1 - <REPLACE>prob_Z_leq_threshold</REPLACE></a><br />
= <REPLACE>prob_Z_gt_threshold</REPLACE>.
</blockquote>
The empirical probability of margin outperforming regular investing in the above table is <REPLACE>actual_percent_times_margin_is_better</REPLACE>%.

<h4>Relaxing the simplifying assumptions</h4>

When doing this empirical validation, I ran the simulation with many complicating factors ignored in order to better match theory. This section shows how the results change as the complicating factors are gradually added back in, until eventually we arrive back at the complicated, "default" configuration.

<h5>From simple scenario, relax assumption of only earning one initial paycheck</h5>

<REPLACE>closetotheoryminus1_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus1_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus1_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus1_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h5>From that, relax assumption of maintaining leverage equal to broker max</h5>

<REPLACE>closetotheoryminus2_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus2_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus2_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus2_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h5>From that, relax assumption of not tapering off leverage toward end</h5>

<REPLACE>closetotheoryminus3_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus3_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus3_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus3_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h5>From that, relax assumption of no black swans</h5>

<REPLACE>closetotheoryminus4_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus4_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus4_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus4_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h5>From that, relax assumption of no taxes</h5>

<REPLACE>closetotheoryminus5_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus5_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus5_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus5_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h5>From that, relax assumption of no inflation</h5>

<REPLACE>closetotheoryminus6_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus6_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus6_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus6_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h5>From that, relax assumption of no unemployment</h5>

<REPLACE>closetotheoryminus7_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus7_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus7_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus7_percdiff</REPLACE>" title="I release this image into the public domain worldwide." /></span>

The only assumption left here is that of no emergency funds. Relaxing this assumption too would bring us back to the results table for the "default" parameter configuration discussed earlier.

<!--
Based only on the fraction of times it wins, margin doesn't look so promising. I tracked this low performance down to at least these factors, in rough order of importance:
<ol>
<li>Rebalancing monthly dramatically reduces the chance that margin beats regular investing.</li>
<li>Investing a single amount of cash one time has a lower rate of margin beating regular investing than investing many regular salary payments.</li>
</ol>
FIX THIS TO ACCOUNT FOR LONGER TIMES DOING WORSE! THE VARIATIONS I REPORT BELOW SHOULD BE FOR SHORTER TIME PERIODS? OR TAKE THIS OUT ALTOGETHER and take out those scenarios too

If we take the same settings in the results table immediately above but instead don't rebalance monthly, the probability of margin outperforming regular investing rises<span style="color:orange">CHECK THIS MANUALLY</span> to <REPLACE>uitbfdontreb_percent_margin_better</REPLACE>%, and if we also let the investor earn paychecks every month rather than only in the first month, the probability of margin outperforming regular investing rises further<span style="color:orange">CHECK THIS MANUALLY</span> to <REPLACE>uitbdontreb_percent_margin_better</REPLACE>%.

"<a href="http://www.mathisen.ca/leveraging/leveraging.pdf">Understanding Investment Leverage</a>" notes that margin performs better when the average stock/ETF returns exceed a "break-even" threshold. Assuming that capital-gains taxes and tax deductions aren't especially relevant, the break-even threshold should roughly be the margin interest rate -- call it r. In other words, the probability that margin beats non-margin for a given dollar invested is roughly the probability that the t-year returns of investing in the market beat the t-year accumulation of interest at rate r. Let X<sub>t</sub> be the random variable representing the accumulated t-year market return, and let Z be a standard-normal random variable. Then
<blockquote>
Prob[&nbsp;margin beats regular&nbsp;] &asymp; Prob[&nbsp;investments exceed break-even threshold&nbsp;] = Prob[&nbsp;exp(X<sub>t</sub>) > exp(rt)&nbsp;] = Prob[&nbsp;X<sub>t</sub> > rt&nbsp;] = Prob[&nbsp;&mu;t + Z&sigma;&radic;<span style="text-decoration: overline">t</span> > rt&nbsp;] = Prob[&nbsp;Z&sigma;&radic;<span style="text-decoration: overline">t</span> > (r-&mu;)t&nbsp;] = Prob[&nbsp;Z > ( (r-&mu;)/&sigma; ) &radic;<span style="text-decoration: overline">t</span>&nbsp;] = 1 - Prob[&nbsp;Z &le; ( (r-&mu;)/&sigma; ) &radic;<span style="text-decoration: overline">t</span>&nbsp;&nbsp;] = 1 - Prob[&nbsp;Z &le; ( (<REPLACE>annual_margin_interest_rate</REPLACE>-<REPLACE>annual_mu</REPLACE>)/<REPLACE>annual_sigma</REPLACE> ) &radic;<span style="text-decoration: overline"><REPLACE>years_until_donate</REPLACE></span>&nbsp;&nbsp;] = 1 - Prob[&nbsp;Z &le; <REPLACE>Z_value_threshold</REPLACE>&nbsp;] <a href="https://surfstat.anu.edu.au/surfstat-home/tables/normal.php" title="&quot;SurfStat standard normal calculator&quot;">= 1 - <REPLACE>prob_Z_leq_threshold</REPLACE></a> = <REPLACE>prob_Z_gt_threshold</REPLACE>.
</blockquote>
-->

<h2>401k matching beats leverage</h2>

<i>Lifecycle Investing</i> points out that most 401k plans don't allow leverage. But many employers match 401k contributions at a 2X or 1.5X rate. The book says you should always max out matching 401k contributions before investing with leverage on your own.

To test this out, I added to my simulation an investor who just contributed to a regular, non-margin brokerage account but was able to put in <REPLACE>match_percent_from_401k</REPLACE>% more than normal. For instance, if regular investors contributed $2500/month, this investor contributed $3750/month. In practice, employers typically cap the amount of 401k contributions that can be matched per pay period at a relatively low level, but I ignored that point so that I could compare the 401k investor on equal footing with the other investors, and then if I saw the 401k investor beating the others, it would follow that any given dollar of employer-matched 401k investing would beat any given dollar of non-employer-matched margin investing, which would imply that you should max out employer matching first and only then use margin investing for the remaining income.

I did indeed find that a <REPLACE>match_percent_from_401k</REPLACE>%-matched 401k beat either other type of investing. This was shown in the results table in the previous section. Before I added tax logic to my simulation, the 401k-matching strategy returned <i>exactly</i> 1.5 times the regular investing strategy, which it should given that I compared the investments with respect to the same random stock-market returns.

In reality, the amount you can contribute to a <REPLACE>match_percent_from_401k</REPLACE>% matched 401k is more than <REPLACE>match_percent_from_401k</REPLACE>% of what you can invest on margin on your own because a 401k is pre-tax, while margin investing uses post-tax dollars. However, you'll later have to pay taxes on your 401k withdrawals, so if your tax rate is the same now vs. in retirement, the tax-deferred nature of 401k contributions doesn't matter, since the amount at the end is (1-income_tax_rate) times (the pre-tax income that you put in plus equity appreciation). That said, if (as is common) you expect to have a lower marginal tax rate in retirement, this makes 401k contributing look even more favorable.

<h3>What about non-matched 401k?</h3>

The annual contribution limit for a 401k <a href="http://www.irs.gov/uac/Newsroom/IRS-Announces-2015-Pension-Plan-Limitations-1" title="&quot;IRS Announces 2015 Pension Plan Limitations; Taxpayers May Contribute up to $18,000 to their 401(k) plans in 2015&quot;">is $18K</a>, which is probably higher than the amount that your employer matches. Should you only contribute to your 401k the amount your employer matches and invest the remainder in an after-tax margin account using leverage? Or should you contribute all $18K to the 401k and let the money grow tax-free there? The choice isn't obvious, and following are some considerations in favor of each option.

<h4>Reasons favoring 401k:</h4>

<ul>
<li>If you expect to have a lot of income during retirement, you'd presumably pay at least 15% taxes on capital gains outside a 401k. In the default margin-investing scenario above, margin investing beat regular investing by ~<REPLACE>margin_better_than_regular_percent</REPLACE>% in expectation <i>with higher risk</i>. So if you plan to spend the savings on yourself, if you use a margin account, your savings would be only (1 + .<REPLACE>margin_better_than_regular_percent</REPLACE>)(1 - <REPLACE>long_term_cap_gains_rate</REPLACE>) = <REPLACE>(1+margin_advantage)(1-long_term_cap_gains)</REPLACE> as much as if you had put them in a non-leveraged 401k account that doesn't incur capital-gains taxes.</li>
<li>If you expect to be in a lower income bracket during retirement (say 15% instead of 28%), then contributing to a 401k allows you to pay less income tax in addition to no capital-gains tax.</li>
</ul>

<h4>Reasons favoring margin investing:</h4>

<ul>
<li>Plausibly you can get enough retirement savings just by the amount you contribute to your 401k for employer matching. In this case, you could donate your margin-invested securities and not pay capital-gains tax on them. If so, the only advantage of a 401k is that you might be in a lower income bracket during retirement.</li>
<li>Contributing to a 401k locks the money in your retirement account for several decades. What if you want to donate it sooner? What if the financial system as a whole changes radically during those years, such that your 401k money becomes less valuable?</li>
<li>Currently, people in the 15% income bracket or below pay no capital-gains tax. So if your income during retirement was low enough, you might be able to spend your margin-invested savings on yourself without paying capital-gains tax. However, it might be hard to keep your income during retirement low enough to be sure you won't pay capital-gains taxes. Likewise, it's quite possible that Congress will change capital-gains rates by the time of your retirement, so that even people in the 15% income bracket will pay capital-gains taxes.</li>
<li>As we saw above, margin investing returns an expected <REPLACE>margin_better_than_regular_percent</REPLACE>% more than regular investing, according to the default simulation parameters. On the other hand, having some additional investments in a non-leveraged 401k could reduce your risk of a financial blow-up.</li>
</ul>

<h2>Donor-advised fund vs. leverage</h2>

As with a 401k, I don't think you can use leverage in a donor-advised fund (DAF). So should you forgo the DAF in order to use margin? The answer may depend on your situation.

<h3>How much is a DAF worth?</h3>

The advantage of a DAF is that you can deduct a donation from your income taxes immediately rather than when you eventually pick a charity to receive the funds.

<h4>If you donate small amounts</h4>

For small-time donors, deducting a donation now vs. later may not be crucial. Because of the time value of money, a given amount of tax deduction now is worth more than the same amount taken later. But if you wait until later, your funds to donate should in general have grown in value, so the value of deduction later will actually be larger, which roughly cancels the argument from time value of money for donating sooner. So the value of DAF donating is roughly zero for these donors, ignoring other confounding factors such as that donating to a DAF may help maintain your commitment to donating but may also lock you in to donating to just US-based 501(c)(3)'s rather than other organizations.

<h4>If you donate a lot</h4>

In contrast, donating to a DAF is quite important for big-time donors who plan to give at least 50% of adjusted gross (AGI) income each year. This is because donating every year helps these donors take full advantage of deductions given that at most 50% of a person's AGI can be deducted for charity contributions in a single year. Charitable deductions above 50% carry forward to future years, but if you consistently donate above 50% <i>every year</i>, you'll never get a chance to take all your accumulated charity deductions. Hence, deducting charity donations each year that you earn becomes important.

If a donor in this situation doesn't have a charity picked out yet and would lose the year's charitable deductions if she didn't donate to a DAF, then donating to a DAF saves taxes. Say the donor is deep in the 28% marginal income bracket. By donating some amount $X (assume $X is below the 50%-of-AGI limit), she gets $.28X back on taxes (and that refund is untaxed), so it's as if she multiplied her money by 1.28. In other words, donating to a DAF is similar to donating to a 401k that matches 28% rather than <REPLACE>match_percent_from_401k</REPLACE>%.

Whether this is better than leverage depends on the donor's risk tolerance and the advantage of leverage. For a risk-neutral investor, the DAF is better only if the expected wealth of using margin is less than 28% higher than not. For a risk-averse investor with utility(wealth) = &radic;<span style="text-decoration: overline">wealth</span>, the DAF is better unless the expected-utility value in the above table is more than &radic;<span style="text-decoration: overline">1.28</span> times better for margin than non-margin (which it isn't). The reason for the &radic;<span style="text-decoration: overline">1.28</span> threshold is that donating to a DAF multiplies wealth by 1.28 with certainty, which means it multiplies expected &radic;<span style="text-decoration: overline">wealth</span> by &radic;<span style="text-decoration: overline">1.28</span>.

<h2>ESPP plans</h2>

A company's ESPP plan offers employees the opportunity to buy some amount of company stock at a discount (say, 10%). You should always participate in such programs, because if nothing else, you can just sell the stocks after you buy them (incurring taxes in the process). But it's better tax-wise to hold for at least 2 years before selling or donating.

If you use margin investing, ESPP shares can (presumably?) just contribute to your assets, allowing you to borrow more. In contrast, if you use leveraged ETFs for leverage, then (non-leveraged) ESPP shares don't allow you to get leverage. In this case, you can trade off the tax penalty for selling the ESPP shares early (say, 14% or 28% income tax) against whatever percent benefit you see from investing that amount of money with leverage.

<h2>Optimal leverage</h2>

In practice, margin leverage is not unlimited. But suppose it were. What would be the best amount of leverage to use?

<h3>Maximizing expected average return</h3>

In 2007, when I first learned about the <a href="https://en.wikipedia.org/wiki/Capital_allocation_line">capital allocation line</a>, I saw that it suggests an investor could get arbitrarily high expected returns with arbitrarily high amounts of leverage. For a purely risk-neutral investor, this is a bonanza.

However, as <a href="http://www.fsa.ulaval.ca/nfa2003/papiers/Craig%20Wilson.pdf" title="'Leveraged Stock Portfolios over Long Holding Periods: A Continuous Time Model' (2003)">Domian et al. (2003)</a> explain: "In the single-period CAPM, expected return is an increasing linear function of the degree of leverage. But in our continuous time model, expected annualized return is a concave function of leverage." In fact, <a href="http://www.fsa.ulaval.ca/nfa2003/papiers/Craig%20Wilson.pdf" title="'Leveraged Stock Portfolios over Long Holding Periods: A Continuous Time Model' (2003)">Domian et al. (2003)</a> show that using c-times leverage (e.g., c = 2 means 2X leverage) and investing a fixed initial sum of wealth:
<blockquote>
E[R<sub>t</sub>] = r + (&mu; - r)c - &sigma;<sup>2</sup>c<sup>2</sup>/2
</blockquote>
where r is the borrowing interest rate, E[] indicates expected value, and
<blockquote>
R<sub>t</sub> := (1/t) ln(V<sub>t</sub>/V<sub>0</sub>)
</blockquote>
is the geometric-average t-year continuously compounded return((The geometric-average t-year return not compounding continuously is
<blockquote>
&Rho;<sub>t</sub> := (V<sub>t</sub>/V<sub>0</sub>)<sup>1/t</sup> - 1,
</blockquote>
since (1+&Rho;<sub>t</sub>)<sup>t</sup> = V<sub>t</sub>/V<sub>0</sub>.

Recall that in general, the continuously compounded equivalent of some return x is the number y such that (1+x) = e<sup>y</sup>, i.e., y = ln(1+x). So the continuously compounded version of &Rho;<sub>t</sub> is
<blockquote>
ln(1+&Rho;<sub>t</sub>) = ln[ (V<sub>t</sub>/V<sub>0</sub>)<sup>1/t</sup> ] = R<sub>t</sub>.
</blockquote>)), where V<sub>t</sub> is the t-year accumulated wealth and V<sub>0</sub> is the starting wealth.

<a href="http://www.fsa.ulaval.ca/nfa2003/papiers/Craig%20Wilson.pdf" title="'Leveraged Stock Portfolios over Long Holding Periods: A Continuous Time Model' (2003)">Domian et al. (2003)</a> show (eqn. 20, p. 7) that the leverage amount c<sup>*</sup> which optimizes E[R<sub>t</sub>] is
<blockquote>
c<sup>*</sup> = (&mu; - r)/&sigma;<sup>2</sup>.
</blockquote>
Using the parameter values for my default simulation, this optimal fraction is (<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)/<REPLACE>annual_sigma</REPLACE><sup>2</sup> = <REPLACE>Kelly_ratio_as_percent</REPLACE>%. Hence, this suggests using no leverage and splitting 50:50<span style="color:orange">CHECK THIS MANUALLY</span> between stocks and bonds! This isn't consistent with my results or with conventional wisdom. Of course, the parameters I used in this calculation were quite conservative. Based on historical US data, some people would set &mu; at more like .1, in which case the optimal betting fraction would be <REPLACE>Kelly_ratio_if_mu_is_10_percent</REPLACE>, i.e., almost 1.5X leverage.<span style="color:orange">CHECK THIS MANUALLY</span>

The c<sup>*</sup> formula above corresponds to the <a href="https://en.wikipedia.org/wiki/Kelly_criterion">Kelly criterion</a>. <a href="https://www.math.washington.edu/~morrow/336_10/papers/jane.pdf" title="&quot;Betting with the Kelly Criterion&quot;">This summary</a> reviews how to derive the c<sup>*</sup> equation in a different way (p. 5). The Kelly criterion <a href="http://finance.martinsewell.com/money-management/Markowitz1976.pdf" title="see p. 1273 of 'Investment for the long run: New evidence for an old rule' by Harry Markowitz (1976)">optimizes</a> the growth rate of a portfolio with a single initial investment over the infinite future, i.e., R<sub>&infin;</sub> using the above notation. This is equivalent to optimizing E[R<sub>1</sub>] because, <a href="http://finance.martinsewell.com/money-management/Markowitz1976.pdf" title="see p. 1274, eqn. 4 of 'Investment for the long run: New evidence for an old rule' by Harry Markowitz (1976)">by</a> the strong law of large numbers, R<sub>&infin;</sub> = E[R<sub>1</sub>] with probability 1. Since E[R<sub>t</sub>] doesn't depend on t, what optimizes optimizes E[R<sub>t</sub>] in general also optimizes E[R<sub>1</sub>].

<h3>Maximizing expected utility</h3>

However, even though the Kelly criterion beats any other investment policy after a gazillion years, it doesn't beat any other investment policy after the <REPLACE>years_until_donate</REPLACE> years before the investor donates the accumulated savings. In particular, note that the Kelly criterion is extremely worried about bankruptcy, since that nullifies all hope of future returns, while for a <REPLACE>years_until_donate</REPLACE>-year altruistic investor, bankruptcy is sad but potentially worth the risk of greater return.

A better policy for finite time horizons is just to optimize the expected utility that will result from the donated wealth. Let u(V<sub>t</sub>) be the utility of donating an amount V<sub>t</sub>. Typically u is concave because additional dollars contribute less value. Also, in a world where other charity donations are highly correlated with yours based on market performance, if you get a lot of wealth because the market does well, other investors are also getting a lot of wealth, and hence, the value of a donate dollar <a href="http://reducing-suffering.org/when-should-altruists-be-financially-risk-averse/#Money_is_less_valuable_in_richer_worlds">isn't quite as high</a>. For these reasons, I've used u(V<sub>t</sub>) = &radic;<span style="text-decoration: overline">V</span><sub>t</sub> in the results tables of this piece.

<h4>Case 1: utility(wealth) = ln(wealth)</h4>

For a given time horizon t, maximizing E[u(V<sub>t</sub>)] is equivalent to maximizing E[u(V<sub>t</sub>) - u(V<sub>0</sub>)], since V<sub>0</sub> is a known constant. It's also equivalent to maximizing E{ (1/t) [u(V<sub>t</sub>) - u(V<sub>0</sub>)] }, since t is a constant. Note that if u(V<sub>t</sub>) = ln(V<sub>t</sub>), then maximizing E{ (1/t) [u(V<sub>t</sub>) - u(V<sub>0</sub>)] } means maximizing E[ (1/t) ln(V<sub>t</sub>/V<sub>0</sub>) ] = E[R<sub>t</sub>]. This is the Kelly optimization problem from before. So in this case, the Kelly criterion also optimizes expected utility.

But u(V<sub>t</sub>) = ln(V<sub>t</sub>) is a weird utility function. It places <i>infinite</i> disvalue on going bankrupt, since u(0) = ln(0) = -&infin;. Also, a logarithmic utility curve seems too pessimistic for an altruist, even considering the correlation of your returns with the returns of other donors, since there are still many valuable uses of money even in a richer world.

<h4>Case 2: utility(wealth) = wealth</h4>

<a href="http://www.fsa.ulaval.ca/nfa2003/papiers/Craig%20Wilson.pdf" title="'Leveraged Stock Portfolios over Long Holding Periods: A Continuous Time Model' (2003)">Domian et al. (2003)</a> prove the following equation (eq. 14, p. 5), using the same variable meanings as in the previous section of their paper:
<blockquote>
V<sub>t</sub> = V<sub>0</sub> exp{ [r + (&mu;-r)c - &sigma;<sup>2</sup>c<sup>2</sup>/2 ]t + &sigma;cW<sub>t</sub> },
</blockquote>
where W<sub>t</sub> is a standard Brownian motion with mean 0 and annual variance t. Because W<sub>t</sub> is normally distributed, V<sub>t</sub> is lognormally distributed, and (eq. 15, p. 5)
<blockquote>
E[V<sub>t</sub>] = V<sub>0</sub> exp{ [r + (&mu;-r)c]t - [&sigma;<sup>2</sup>c<sup>2</sup>/2] t + [&sigma;<sup>2</sup>c<sup>2</sup>t/2] }<br />
= V<sub>0</sub>exp{ [r + (&mu;-r)c]t },
</blockquote>
where the extra &sigma;<sup>2</sup>c<sup>2</sup>t/2 comes in because the mean of a lognormal distribution is greater than exp{the mean of the underlying normal distribution} because the exp{} function is convex.

The interesting thing about the equation for E[V<sub>t</sub>] is that for &mu; > r, it's increasing in c, i.e., if you want to maximize expected ending wealth because E[u(V<sub>t</sub>)] = E[V<sub>t</sub>], then you should indeed partake of a leverage bonanza by maxing out leverage.

<h4>Case 3: utility(wealth) = (wealth)<sup>&alpha;</sup></h4>

Suppose you have a risk-averse utility function but one that's not fully logarithmic like in the Kelly criterion. In particular, let utility(wealth) = (wealth)<sup>&alpha;</sup>. In the results tables of this piece, I've been taking &alpha; = .5, i.e., utility(wealth) = &radic;<span style="text-decoration: overline">wealth</span>. Based on the formula for V<sub>t</sub>, we have that
<blockquote>
u(V<sub>t</sub>) := V<sub>t</sub><sup>&alpha;</sup> = V<sub>0</sub><sup>&alpha;</sup> exp{ [r + (&mu;-r)c - &sigma;<sup>2</sup>c<sup>2</sup>/2 ]t&alpha; + &sigma;cW<sub>t</sub>&alpha; }.
</blockquote>
Then, again using the fact about the mean of a lognormal distribution,
<blockquote>
E[u(V<sub>t</sub>)] = V<sub>0</sub><sup>&alpha;</sup> exp{ [r + (&mu;-r)c]t&alpha; - [&sigma;<sup>2</sup>c<sup>2</sup>/2] t&alpha; + [&sigma;<sup>2</sup>c<sup>2</sup>t&alpha;<sup>2</sup>/2] }<br />
= V<sub>0</sub><sup>&alpha;</sup> exp{ [r + (&mu;-r)c]t&alpha; + [&sigma;<sup>2</sup>c<sup>2</sup>/2] t(&alpha;<sup>2</sup>-&alpha;) }.
</blockquote>
Since usually 0 < &alpha; < 1, (&alpha;<sup>2</sup>-&alpha;) is negative, which means the optimization is now not trivial the way it was when utility was linear in wealth, because the exponent has a negative times the c<sup>2</sup> part and a positive times only a c, so with sufficiently big c, expected utility will start to decline. In particular, it turns out that the optimal leverage c<sup>*</sup> is((Here's the derivation. E[u(V<sub>t</sub>)] has the form (constant) * exp( t&alpha; g(c) ), where
<blockquote>
g(c) := r + (&mu;-r)c + [&sigma;<sup>2</sup>c<sup>2</sup>/2] (&alpha;-1).
</blockquote>
To maximize expected utility, it suffices to maximize the exponent g(c), since that's the only part of the expression that depends on c. The optimal value of c, c<sup>*</sup>, occurs where the first derivative, g'(c), is 0:
<blockquote>
g'(c<sup>*</sup>) = 0<br />
&mu;-r + &sigma;<sup>2</sup>c<sup>*</sup> (&alpha;-1) = 0<br />
&mu;-r = &sigma;<sup>2</sup>c<sup>*</sup> (1-&alpha;)<br />
c<sup>*</sup> = (&mu;-r)/[&sigma;<sup>2</sup> (1-&alpha;)].<br />
</blockquote>
This is indeed a maximum of g(c) because
<blockquote>
g''(c<sup>*</sup>) = &sigma;<sup>2</sup> (&alpha;-1) < 0 for &alpha; in the interval (0,1).
</blockquote>))
<blockquote>
c<sup>*</sup> = (&mu;-r) / [&sigma;<sup>2</sup>(1-&alpha;)] = (Kelly-criterion optimal c value)/(1-&alpha;).
</blockquote><!--
<blockquote>
&part;E[utility(V<sub>t</sub>)] / &part;c = V<sub>0</sub><sup>&alpha;</sup> exp{ [r + (&mu;-r)c]t&alpha; + [&sigma;<sup>2</sup>c<sup>2</sup>/2] t(&alpha;<sup>2</sup>-&alpha;) } * [ (&mu;-r)t&alpha; + c&sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ].
</blockquote>
Set this equation equal to 0. The first two factors are always positive, so in order for the equation to be 0, the last factor needs to be 0. At c<sup>*</sup>:
<blockquote>
(&mu;-r)t&alpha; + c<sup>*</sup>&sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) = 0<br />
c<sup>*</sup> = -(&mu;-r)t&alpha; / [ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ]<br />
c<sup>*</sup> = (&mu;-r)&alpha; / [ &sigma;<sup>2</sup>(&alpha;-&alpha;<sup>2</sup>) ]<br />
c<sup>*</sup> = [(&mu;-r) / &sigma;<sup>2</sup>][&alpha;/(&alpha;-&alpha;<sup>2</sup>)]<br />
c<sup>*</sup> = [(&mu;-r) / &sigma;<sup>2</sup>][1/(1-&alpha;)] = (Kelly-criterion optimal c value)/(1-&alpha;).<br />
</blockquote>


Setting the derivative to zero does indeed locate a maximum, because the second derivative with respect to c is negative at c<sup>*</sup>. Using the formula for &part;E[utility(V<sub>t</sub>)] / &part;c from the text, we have (using the product rule):
<blockquote>
&part;<sup>2</sup> E[utility(V<sub>t</sub>)] / &part;c<sup>2</sup> = <br />
V<sub>0</sub><sup>&alpha;</sup> exp{ [r + (&mu;-r)c]t&alpha; + [&sigma;<sup>2</sup>c<sup>2</sup>/2] t(&alpha;<sup>2</sup>-&alpha;) } * [ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + <br />
V<sub>0</sub><sup>&alpha;</sup> exp{ [r + (&mu;-r)c]t&alpha; + [&sigma;<sup>2</sup>c<sup>2</sup>/2] t(&alpha;<sup>2</sup>-&alpha;) } * [ (&mu;-r)t&alpha; + c&sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ]<sup>2</sup>.
</blockquote>
The V<sub>0</sub><sup>&alpha;</sup> and exp{} factors are positive and so don't affect the sign of the result. Hence we can factor them out and focus on what's left:
<blockquote>
[ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ (&mu;-r)t&alpha; + c&sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ]<sup>2</sup><!--= [ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ (&mu;-r)t&alpha; ]<sup>2</sup> + 2 [ (&mu;-r)t&alpha; ][ c&sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ c&sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ]<sup>2</sup>-- >.
</blockquote>
In the main text, it will be shown that the first derivative of expected utility is 0 when c = [(&mu;-r) / &sigma;<sup>2</sup>]/(1-&alpha;). Since we want to evaluate the second derivative at that value, we can substitute this in to the preceding equation:
<blockquote>
[ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ (&mu;-r)t&alpha; + {[(&mu;-r) / &sigma;<sup>2</sup>]/(1-&alpha;)} &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ]<sup>2</sup><br />
= [ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ (&mu;-r)t&alpha; + {(&mu;-r)/(1-&alpha;)} t(&alpha;<sup>2</sup>-&alpha;) ]<sup>2</sup><br />
= [ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ (&mu;-r)t&alpha; - (&mu;-r)t&alpha; ]<sup>2</sup><br />
= [ &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) ] + [ 0 ]<sup>2</sup>,
</blockquote>
which is always negative for for &alpha; values in the interval (0,1).<!--
Define x := &sigma;<sup>2</sup>t(&alpha;<sup>2</sup>-&alpha;) and y := (&mu;-r)t&alpha;. Then the equation becomes
<blockquote>
<!--x + y<sup>2</sup> + 2 cxy + c<sup>2</sup>x<sup>2</sup><br />-- >= x + (cx+y)<sup>2</sup>.
</blockquote>
It's still not obvious how to evaluate the sign of this, since x < 0 while (cx+y)<sup>2</sup> > 0.

Let's plug in the default parameter values for this essay:
<blockquote>
x = <REPLACE>annual_sigma</REPLACE><sup>2</sup><REPLACE>years_until_donate</REPLACE>(.5<sup>2</sup>-.5) = <REPLACE>x_value_for_second_derivative</REPLACE><br />
y = (<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)*<REPLACE>years_until_donate</REPLACE>*.5 = <REPLACE>y_value_for_second_derivative</REPLACE>.
</blockquote>
And, as will be shown in the main text, c<sup>*</sup> = <REPLACE>c_star_for_alpha_equals_one_half</REPLACE>. Hence, 
<blockquote>
x + (c<sup>*</sup>x+y)<sup>2</sup> = <REPLACE>x_value_for_second_derivative</REPLACE> + (<REPLACE>c_star_for_alpha_equals_one_half</REPLACE> * <REPLACE>x_value_for_second_derivative</REPLACE> + <REPLACE>y_value_for_second_derivative</REPLACE>)<sup>2</sup> = <REPLACE>full_equation_with_x_y_and_c</REPLACE> < 0.
</blockquote>
Because x and y are roughly equal and opposite in magnitude, when c<sup>*</sup> is near 1, the squared term is roughly 0, so the result is roughly equal to x, which is necessarily negative for &alpha; values in the interval (0,1).-- >)):

<!--
I WAS SILLY AND DIDN'T REALIZE THE dEV/dc = 0 EQUATION WAS EASY TO SOLVE. THIS IS FROM BEFORE I REALIZED THAT:

Since this expression is ugly, I plotted it in Wolfram Alpha, using the default parameters in this piece (including &alpha; = .5 and t = <REPLACE>years_until_donate</REPLACE>) and setting V<sub>0</sub> = 1 since it's irrelevant to solving the equation:
<blockquote>
<a href="https://www.wolframalpha.com/input/?i=plot%5Bexp%7B+%5B.03+%2B+%28.054-.03%29c%5D*15*.5+%2B+%5B.22%5E2*c%5E2%2F2%5D+*+15+*+%28.5%5E2-.5%29+%7D+*+%5B+%28.054-.03%29*15*.5+%2B+c*.22%5E2*15*%28.5%5E2-.5%29+%5D%2Cc%2C0%2C25%5D">plot[exp{ [<REPLACE>annual_margin_interest_rate</REPLACE> + (<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)c]*<REPLACE>years_until_donate</REPLACE>*.5 + [<REPLACE>annual_sigma</REPLACE>^2*c^2/2] * <REPLACE>years_until_donate</REPLACE> * (.5^2-.5) } * [ (<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)*<REPLACE>years_until_donate</REPLACE>*.5 + c*<REPLACE>annual_sigma</REPLACE>^2*<REPLACE>years_until_donate</REPLACE>*(.5^2-.5) ],c,0,10]</a><span style="color:orange">REWRITE PRECEDING LINK IF PARAMS CHANGE!</span> <!-- with current params: plot[exp{ [.03 + (.054-.03)c]*15*.5 + [.22^2*c^2/2] * 15 * (.5^2-.5) } * [ (.054-.03)*15*.5 + c*.22^2*15*(.5^2-.5) ],c,0,10] -- >
</blockquote>
If we set equal to 0 and <a href="https://www.wolframalpha.com/input/?i=solve%5Bexp%7B+%5B.03+%2B+%28.054-.03%29c%5D*15*.5+%2B+%5B.22%5E2*c%5E2%2F2%5D+*+15+*+%28.5%5E2-.5%29+%7D+*+%5B+%28.054-.03%29*15*.5+%2B+c*.22%5E2*15*%28.5%5E2-.5%29+%5D%3D0%2Cc%5D">solve the equation</a>, <span style="color:orange">REWRITE PRECEDING LINK IF PARAMS CHANGE!</span> we get c<sup>*</sup> = <REPLACE>c_star_for_alpha_equals_one_half</REPLACE>.

If &alpha; had been 0.75, we would have had c<sup>*</sup> = <REPLACE>c_star_for_alpha_equals_three_fourths</REPLACE>, and for &alpha; = 0.25, c<sup>*</sup> = <REPLACE>c_star_for_alpha_equals_one_fourth</REPLACE>.<!-- use this equation and ctrl+h on a with the alpha value:  solve[exp{ [.03 + (.054-.03)c]*15*a + [.22^2*c^2/2] * 15 * (a^2-a) } * [ (.054-.03)*15*a + c*.22^2*15*(a^2-a) ]=0,c]  -->Here's a plot of c<sup>*</sup> vs. &alpha; for the default parameters used in this piece<!--It uses Python's numerical equation solver for the full &part;E[utility(V<sub>t</sub>)] / &part;c equation rather than the analytical formula and hence is a nice sanity check.-->:

<span class="fullwidthimage"><img src="<REPLACE>c_star_vs_alpha_fig</REPLACE>" title="I release this image into the public domain worldwide." /></span>

If we took a more optimistic value for &mu; (say, &mu;=<REPLACE>optimistic_mu</REPLACE>), we would instead have this graph:

<span class="fullwidthimage"><img src="<REPLACE>optimistic_c_star_vs_alpha_fig</REPLACE>" title="I release this image into the public domain worldwide." /></span>

The equation c<sup>*</sup> = (&mu;-r) / [&sigma;<sup>2</sup>(1-&alpha;)] works not just for &alpha; values between 0 and 1 but also (heuristically only!) for the edge cases: &alpha; = 0 and &alpha; = 1. If we say that &alpha; = 0 means utility(wealth) = ln(wealth), which is the assumption behind the Kelly criterion, then our equation falls back to the Kelly equation (Case 1). And for &alpha; = 1, utility(wealth) = wealth, so the investor is risk-neutral and thus should aim for infinite leverage (Case 2).


<h3>Simulations in the literature</h3>

"<a href="http://www.investmentreview.com/files/2009/12/leveraged_portfolios1.pdf">Leveraged Canadian Stock Portfolios: Long-Run Effects on Wealth and Risk</a>" (2003) presents a simulation of leveraged investing based on actual historical returns between 1950 and 2001. The authors found that the optimal amount of leverage over this period would have been about 1.5X (rebalancing monthly). 4X leverage left almost no ending wealth, although this was partly because the simulation assumed monthly rebalancing, whereas daily rebalancing can reduce the risk of wipeout. The paper's Figure 1 shows an inverted U curve for the ending wealth of an investor from 1950 to 2001 as a function of how much leverage she used, between 1X and 4X.

"<a href="https://www.questia.com/library/journal/1P3-977793091/wealth-and-risk-from-leveraged-stock-portfolios">Wealth and Risk from Leveraged Stock Portfolios</a>" (2002) found optimal leverage of 1.7X assuming borrowing at 2% above Treasury bills. The authors note: "A modest amount of leverage enhances the performance of stock portfolios in the long run. However, higher amounts of leverage produce dramatic declines in long-run wealth."

<h3>My results</h3>

<h4>Case 1: Simplifying parameters in an attempt to match theory</h4>

Before getting simulation results for realistic parameter settings, I wanted to see how close I could get to the theoretical optimal-leverage results discussed above. Thus, I made many simplifying assumptions relative to the default configuration:
<ol>
<li>no unemployment, inflation, taxes, or black swans</li>
<li>invest a single lump sum at the beginning (the investor only earns one initial monthly paycheck on day 0)</li>
<li>the investor doesn't ramp down leverage toward the end of the investing period</li>
<li>the investor's voluntary leverage amount exactly equals the broker max rather than being set comfortably below the broker max, so that the investor maintains constant leverage.</li>
</ol>
While in the theoretical equations, the investor rebalances continuously, here the investor still rebalances only monthly (or daily when the broker liquidates securities to pay excessive margin).

The following graph((In general, I use standard error for error bars because then if two error bars don't overlap, the difference is roughly statistically significant. Since the quantities in this graph are ratios (sample mean #1 divided by sample mean #2), I used a formula for propagation of uncertainty when dividing two uncertain quantities. The full formula <a href="https://en.wikipedia.org/wiki/Propagation_of_uncertainty#Example_formulas">according to Wikipedia</a> is
<blockquote>
if f = A/B then &sigma;<sub>f</sub> is roughly |f| &radic;[ (&sigma;<sub>A</sub>/A)<sup>2</sup> + (&sigma;<sub>B</sub>/B)<sup>2</sup> - 2&sigma;<sub>AB</sub>/AB ].
</blockquote>
For simplicity, I omitted the correlation component of the equation (the -2&sigma;<sub>AB</sub>/AB part), which only makes my error bars conservatively big given that the sample-mean margin investment performance has a high correlation with the sample-mean regular investment performance, since the sample means for both quantities will be too high when particularly good stock returns are sampled and too low when particularly bad returns are sampled.

Unfortunately, it looks like the error bars in this graph are actually too small. This is because the averages for some leverage amounts clearly deviate from the trend of the curve, and their error bars don't even overlap with the error bars of neighboring points on the curve. But the curve should be continuous in theory. Hence, the error bars must be too small.)) shows how well leverage does compared with non-leveraged investing as a function of the leverage amount. As in the tables above, I took utility(wealth) = &radic;<span style="text-decoration: overline">wealth</span>. Each data point came from <REPLACE>num_trials</REPLACE><span style="color:orange">This often gets messed up</span> trials.

<span class="fullwidthimage"><img src="<REPLACE>closetotheory_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span style="color:red">HOW DOES optimum COMPARE TO THEORY? optimal lev should be ~1 for sqrt() utility or max val for linear utility</span>

The sharp drop in the median with higher leverage underscores why commentators typically warn against constant-leverage investments like leveraged ETFs: Most of the time, the result is terrible, and it's only on rare occasions that you hit the jackpot.

How would the results change if, instead of investing a single lump sum at the beginning, the investor earned a monthly salary? As the <i>Lifecycle Investing</i> authors note, a regular salary is like a bond, so in some sense, investing salary each month should be less leveraged when the investor's whole lifetime assets. If the investor incurs huge losses early on, they can be compensated by later earnings. Following is the same graph as before except that the investor now earns a salary each month.

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus1_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h4>Case 2: Default (realistic) parameter values</h4>

The theoretical equations above assume investing a single lump sum. But for real-world investors, buying securities every month using a salary income stream is generally more realistic.

The default margin configuration involves an investor earning income each month. The following graph shows optimal leverage with all parameters set at their default values.

<span class="fullwidthimage"><img src="<REPLACE>default_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

The peaks of the curves seem to be around 2.5X leverage<span style="color:orange">CHECK THIS MANUALLY</span>, though sticking to 2X<span style="color:orange">CHECK THIS MANUALLY</span> leverage seems like a safe policy to avoid falling off the steep cliff. :)

<!--
TOO HARD TO DO THIS ANALYTICALLY :(

<h2>Optimal leverage if you have emergency funds</h2>

If I were using leverage, I probably wouldn't leverage all of my non-retirement investment income. It would help to have some funds available for emergencies, such as unemployment, allowing you to retire earlier, or funding an important new project that may need money right away.

What does optimal leverage look like if you also have emergency funds that you can donate? Assume you invest those emergency funds in the normal stock market. Then your ending wealth after t years is S<sub>t</sub> + V<sub>t</sub>, with S<sub>0</sub> being the initial amount of your emergency savings, and V<sub>0</sub> being the amount invested on margin.

As in the previous section, we can maximize expected utility in each of three cases.

<h4>Shorthand notation</h4>

Define the following shorthand:
<blockquote>
h(c) := (r + (&mu;-r)c - &sigma;<sup>2</sup>c<sup>2</sup>/2)t + c&sigma;W<sub>t</sub>.
</blockquote>
In particular,
<blockquote>
h(1) = &mu;t - &sigma;<sup>2</sup>t/2 + &sigma;W<sub>t</sub>.
</blockquote>
Recalling the <a href="#regular_S_t">regular S<sub>t</sub> equation</a>, we have
<blockquote>
S<sub>t</sub> = S<sub>0</sub> exp(&mu;t - &sigma;<sup>2</sup>t/2 + &sigma;W<sub>t</sub>) = S<sub>0</sub> exp(h(1)) = exp(ln(S<sub>0</sub>) + h(1)).
</blockquote>
Likewise, recalling the <a href="#leveraged_V_t">leveraged V<sub>t</sub> equation</a>, we have
<blockquote>
V<sub>t</sub> = V<sub>0</sub> exp{ (r + (&mu;-r)c) t - c<sup>2</sup>&sigma;<sup>2</sup>t/2 + c&sigma;W<sub>t</sub> } = V<sub>0</sub> exp(h(c)) = exp(ln(V<sub>0</sub>) + h(c)).
</blockquote>
Also note that the derivative of h with respect to c is
<blockquote>
h'(c) = ((&mu;-r) - &sigma;<sup>2</sup>c)t + &sigma;W<sub>t</sub>.
</blockquote>

<h4>Case 1: utility(wealth) = ln(wealth)</h4>

We want to maximize E[u(wealth)] = E[ ln(S<sub>t</sub> + V<sub>t</sub>) ] with respect to c. Set &part;E[u(wealth)]/&part;c = 0. By continuity, we can move differentiation inside the E[] operator((E[] is an integral with respect to an underlying normal distribution. Formally it extends from -&infin; to &infin;, but we could also approximate it as extending from a really huge fixed negative number to a really huge fixed positive number. Note that u(wealth) and &part;u(wealth)/&part;c are continuous with respect to c and all other variables for any values of those variables, since the expressions involved are just (1) polynomials, (2) exp(), or (3) ln of numbers that are always positive. Hence, <a href="https://en.wikipedia.org/wiki/Differentiation_under_the_integral_sign">we can</a> move differentiation within the integral.)), which means
<blockquote>
E[ &part;u/&part;c ] = 0<br />
E[ 1/(S<sub>t</sub> + V<sub>t</sub>) * (&part;S<sub>t</sub>/&part;c + &part;V<sub>t</sub>/&part;c) ] = 0<br />
E[ 1/(S<sub>t</sub> + V<sub>t</sub>) * (0 + exp(ln(V<sub>0</sub>) + h(c)) * h'(c)) ] = 0<br />
E[ 1/(S<sub>t</sub> + V<sub>t</sub>) * exp(ln(V<sub>0</sub>) + h(c)) * h'(c) ] = 0.
</blockquote>
-->

<h2>Different margin investing policies</h2>

<h3>No emergency savings</h3>

<REPLACE>closetotheoryminus7_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus7_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>closetotheoryminus7_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Emergency savings = $1 million</h3>

(this is also roughly what you'd get if you split between margin and non-margin investing with mostly non-margin investing)

<REPLACE>emergsav1m_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>emergsav1m_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>emergsav1m_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>emergsav1m_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Don't taper off leverage near end of investing period</h3>

<REPLACE>donttaper_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>donttaper_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>donttaper_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>donttaper_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Don't rebalance monthly</h3>

In my default simulation configuration, the investor may become less leveraged over time because she only takes 2X leverage on new equity purchases. If the market rises, her leverage becomes less than 2X due to higher equity without correspondingly higher debt. By default I avoided rebalancing to increase leverage in these cases out of concern that too much rebalancing would be harmful, along the lines of what we see with leveraged ETFs. But I wanted to try a variant where this kind of rebalancing was done monthly if the margin-to-equity ratio fell below <REPLACE>volunary_max_margin_to_assets_as_percent</REPLACE>% (the investor's personal not-quite-2X leverage target). In order to avoid incurring transactions costs on trivially small equity purchases, the investor only buys new ETF shares for rebalancing if she can buy at least $<REPLACE>min_additional_purchase_amount</REPLACE> of such shares at once.

<REPLACE>dontreb_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>dontreb_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>dontreb_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>dontreb_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Remember that <span style="color:red">"2.5X leverage" isn't really 2.5X</span> because in this setting, the investor only rebalances when asset prices fall, not when they rise, so the investor is actually not fully leveraged much of the time. Therefore, don't conclude that you should use 2.5X leverage for a strategy that <i>does</i> rebalance!

TEST THIS: Oddly, the results depend very sensitively on what might seem a trivial parameter: whether, when Interactive Brokers liquidates shares in the investor's account to stay within margin limits, they liquidate random shares or the shares with the biggest capital losses. If Interactive Brokers liquidates random shares, they may leave the investor with big capital gains that will be taxed. If Interactive Brokers liquidates the shares with the biggest losses, they typically leave the investor with net capital losses, of which $3K/year can be deducted from income taxes.

The margin-to-assets ratios for this variation tend to decline more with time as asset prices grow, since the investor isn't actively rebalancing back up toward target leverage. Here's a graph of that for 2X leverage:

<span class="fullwidthimage"><img src="<REPLACE>dontreb_indMTA</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Also, there are many fewer accumulated capital losses because if leverage is less than 2X, there's much less selling of securities to meet margin requirements:

<span class="fullwidthimage"><img src="<REPLACE>dontreb_carrcg</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Don't rebalance monthly and don't taper off leverage toward end</h3>

<REPLACE>dontrebtaper_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>dontrebtaper_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>dontrebtaper_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>dontrebtaper_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Don't rebalance monthly and pay principal throughout</h3>

This is the most conservative strategy. Leverage can be made less risky if, instead of keeping your loans around until the end of the investing period, you pay them off over time as if you were paying off a home mortgage. Doing this means you're less leveraged at later times, as this graph shows (for the 2X leverage configuration):

<span class="fullwidthimage"><img src="<REPLACE>princthru_indMTA</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>princthru_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>princthru_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Obviously this configuration is incompatible with the default policy of rebalancing back up to 2X leverage, since paying off principal throughout reduces the margin-to-assets ratio over time, while a policy of rebalancing to increase leverage would undo that.

For this variation, I used a regular <a href="https://en.wikipedia.org/wiki/Annuity_(finance_theory)#Annuity-due">annuity</a> mortgage calculation to pay off principal such that the investor's margin loans would be fully paid off on the exact date when the investor donates the securities.((This approach of paying off principal over time is suggested in "<a href="http://www.mathisen.ca/leveraging/leveraging.pdf">Understanding Investment Leverage</a>", p. 8, item #6.)) (If the investor doesn't have enough income one month to pay off principal, she sells some of her investments to pay for it. In the simulations I've run, this only happens during months when she's laid off.)

We can see from the results table for this method that it's more certain to outperform non-margin investing due to its safety, though it also has less of an edge over non-margin investing.

<REPLACE>princthru_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>princthru_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Best policy?</h3>

look at graphs...

<h2>Parameter sensitivity analysis</h2>

This section explores how the results change with different parameter configurations, to help ensure that the findings are not specific to the particular input assumptions I made.

<h3>Assume that Interactive Brokers margin liquidations sell the most tax-advantaged lots first</h3>

In the default simulation, I assumed that if you exceed your broker's margin threshold, your broker sells securities randomly to pay off debts, without consideration of whether securities will incur positive capital-gains taxes. This variant instead assumes that your broker liquidates the securities with the biggest percent losses first.

<REPLACE>FO_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>FO_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>FO_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>FO_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Here are some accumulated capital losses for the 2X-leverage version of this configuration:

<span class="fullwidthimage"><img src="<REPLACE>FO_carrcg</REPLACE>" title="I release this image into the public domain worldwide." /></span>

I plan to learn more about IB's actual liquidation algorithm (some sources: <a href="http://www.elitetrader.com/et/index.php?threads/interactive-brokers-real-time-liquidation-madness.210359/">1</a>, <a href="https://www.quantopian.com/posts/interactive-brokers-lack-of-transparency">2</a>, <a href="https://www.google.com/#q=%22interactive%20brokers%22%20%22liquidation%20algorithm%22">3</a>), and if I can get some clues to how it works, I could update my simulations accordingly.        

<h3>Use VIX daily volatilities</h3>

The default simulation assumes a constant annualized volatility of &sigma; = <REPLACE>annual_sigma</REPLACE>. In the real world, volatility swings a lot and sometimes reaches very high levels. How much does this affect the results? To see, I downloaded <a href="http://www.cboe.com/publish/scheduledtask/mktdata/datahouse/vixcurrent.csv">VIX data</a> from <a href="http://www.cboe.com/micro/vix/historical.aspx" title="&quot;VIX Options and Futures Historical Data&quot;">CBOE</a> between 2004 and 2015. This gave a list of volatility numbers. In the simulation, I let the daily volatility values run through that list in order, and if the simulation had more days than the VIX data, I cycled through from the start again. The VIX data include the crash of 2008 (see <a href="http://avondaleam.com/how-good-is-the-vix-at-forecasting-future-volatility/" title="&quot;How Good is the VIX at Forecasting Future Volatility?&quot;">here</a> for a chart of the data), so probably this data set overstates volatility relative to typical market conditions.

<REPLACE>VIX_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>VIX_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>VIX_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>VIX_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Invest for 5 years instead of 15</h3>

"<a href="http://www.mathisen.ca/leveraging/leveraging.pdf">Understanding Investment Leverage</a>" (p. 8) notes that leverage is less risky over longer time horizons. Hence, we'd expect to see higher risk measures for investing over 5 years vs. <REPLACE>years_until_donate</REPLACE> years. That's indeed what we see below.<span style="color:orange">CHECK THIS MANUALLY</span>

<REPLACE>yrs5_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>yrs5_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>yrs5_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>yrs5_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Invest for 30 years instead of 15</h3>

<REPLACE>yrs30_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>yrs30_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>yrs30_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>yrs30_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&mu; = 0.1</h3>

<REPLACE>mu10_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>mu10_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

These results are lower than normal because I'm discounting by exp(-&mu; t), so a higher &mu; implies more discounting. The undiscounted values should actually be higher than for other variants because of higher &mu;.

<span class="fullwidthimage"><img src="<REPLACE>mu10_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>mu10_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&mu; = 0.1 and don't rebalance monthly</h3>

<REPLACE>mu10dontreb_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>mu10dontreb_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>mu10dontreb_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>mu10dontreb_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&mu; = 0.07</h3>

<REPLACE>mu07_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>mu07_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>mu07_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>mu07_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&mu; = 0.04</h3>

<REPLACE>mu04_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>mu04_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>mu04_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>mu04_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&mu; = -0.02</h3>

<REPLACE>mu02minus_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>mu02minus_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>mu02minus_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>mu02minus_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&sigma; = 0.40</h3>

<REPLACE>sig4_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>sig4_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>sig4_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>sig4_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>&sigma; = 0, no black swans, no unemployment</h3>

This variant is mainly useful for debugging. It helps show what effect stock-market and unemployment randomness have on the results.

<REPLACE>sig0_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>sig0_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>sig0_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Margin interest rate = 1.5%</h3>

The actual margin interest rate for Interactive Brokers in 2015 <a href="https://www.interactivebrokers.com/en/index.php?f=interest&p=schedule2" title="&quot;Interest Rates Charged to You on Margin Loan Balances&quot;">is around 1.5%</a>, so I wanted to test this parameter setting rather than just the default, more cautious value of <REPLACE>annual_margin_interest_rate_as_percent</REPLACE>. With &mu; = <REPLACE>annual_mu_as_percent</REPLACE>, this implies an <a href="https://en.wikipedia.org/wiki/Equity_premium_puzzle">equity premium</a> of ~<REPLACE>equity_premium_as_percent</REPLACE>%.

<REPLACE>int_r015_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>int_r015_optimal_leverage_graph</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>int_r015_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>int_r015_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Further simulation features that could be implemented</h3>

The simulation could be made more robust by letting some parameters that are now constants vary, such as the margin <a href="https://en.wikipedia.org/wiki/Short-rate_model#Particular_short-rate_models">interest rate</a>, inflation, the investor's income growth rate, and tax rates. Probably at least some of these should be modeled as <a href="https://en.wikipedia.org/wiki/Mean_reversion_(finance)">mean-reverting processes</a>. I didn't add variation in these parameters to the simulation because I doubted they would make much difference to the trends.

I didn't include tax deductions from margin interest in the simulation because that would have complicated the code. I also didn't think it would make a big difference, because margin interest is only deductible to offset net investment income, and at least when using a buy-and-hold strategy, there's rarely positive net investment income except from dividends, since most securities sales only happen when there's a capital loss that forces rebalancing to pay down debt. (One exception is when the investor becomes unemployed during periods of capital gains and needs to sell securities just to pay interest on margin loans, assuming she doesn't have lots of accumulated capital losses to offset the gains.)

The simulation also doesn't include the impact of dividends, which incur income taxes annually. For instance, suppose the investor has $500K of securities paying 2% annual dividends. That's $10K of extra taxable income per year, which at a 28% tax rate implies almost $3K of extra taxes. (If the donor is maxing out charitable donations during the year, the tax cost <a href="http://reducing-suffering.org/advanced-tips-on-personal-finance/#Marginal_tax_rate_halved_when_you_donate_a_lot">is only half</a> as big.) The difference between the impact of these tax payments for regular vs. margin investing is probably fairly small. If you want, you could approximate taxes on dividends within &mu;: Take your regular &mu; value and subtract, say, (2% dividends)*(28% tax rate) = .02 * .28 = 0.0056.

Fortunately, the errors from omitting <i>both</i> margin-interest deductions and dividends roughly cancel each other out, since dividends may create ~2% taxable income, and a margin interest rate of <REPLACE>annual_margin_interest_rate</REPLACE> can offset ~<REPLACE>annual_margin_interest_rate_as_percent</REPLACE>% of taxable income.

Finally, my simulation may be overly conservative when it comes to black-swan risks. My code assumes that a margin broker can only rebalance to restore margin ratios at the end of a trading day. This means that a 5X-leveraged investor going through 1987's Black Monday would have been completely wiped out. In practice, I think Interactive Brokers would liquidate positions throughout the day if there were big losses, in which case a 5X-leveraged investor wouldn't have been completely wiped out by Black Monday. The simulation could be extended to handle this by making the time granularity some fraction of a day rather than a full day. This would require some updates to parameters for number of days per year, trading days per year, tax dates, etc. It would also make the simulation slower in proportion to the increased number of time steps. Since it's generally not possible in the real world to use 5X margin leverage anyway, it's maybe not crucial to incorporate intra-day rebalancing to the calculations. Still, doing so might affect results for lower leverage amounts too. I wonder with what frequency Interactive Brokers would have done rebalancing on a Black Monday. With a drop like the <a href="https://en.wikipedia.org/wiki/2010_Flash_Crash">2010 Flash Crash</a>, occuring within minutes, there plausibly wouldn't have been enough time for Interactive Brokers to liquidate, but on the other hand, the crash mostly reversed itself within minutes, so it probably also wouldn't have triggered margin calls or destroyed a highly leveraged margin investor.

<h2>Leveraged ETFs</h2>

<h3>Warnings against leveraged ETFs</h3>

If you do a web search for {<a href="https://www.google.com/search?q=leveraged%20ETFs">leveraged ETFs</a>}, you'll find many pages admonishing against using them unless you're a professional trader holding them for at most a few days. This is good advice for most investors most of the time.

<i>Lifecycle Investing</i> recommends leveraged ETFs as one of many leverage options. A <a href="https://www.bogleheads.org/forum/viewtopic.php?f=10&t=153796#p2306778" title="'Re: Anyone actually use leverage (ei ayres and nalebuff)?'">forum comment</a> gives what I expect is the common reaction:
<blockquote>
I'd barely heard of leveraged funds until I read about them in their book, and when I looked into it, what I found was so disturbing that I think it was irresponsible of them to suggest this as a valid way of implement their plan, and if one of them is using this fund I have serious doubts about their competence. It seems clear that they are specifically endorsing the idea of buying and holding a kind of mutual fund whose providers say specifically that it is unsuitable for and should not be used by buy-and-hold investors.
</blockquote>

A <a href="http://dqydj.net/dont-use-leveraged-etfs-unless/" title="'Dont Use Leveraged ETFs (Unless)'">blog post</a> quotes another person as saying: "Levered ETFs can be great...for the short-term.  Otherwise, the decay eats investors alive."

The Bogleheads wiki <a href="http://www.bogleheads.org/wiki/Inverse_and_leveraged_ETFs">entry</a> on leveraged ETFs warns:
<blockquote>
These ETFs are for single-day or very-short-term "trading," speculating, gambling only. They are no good for long-term investing. Regardless of what you might or might not think about the possible usefulness of a long-term leveraged position achieved by using margin, leveraged and inverse ETFs are a completely different thing and do not give even remotely comparable results.
</blockquote>

<h3>Theoretical performance</h3>

The math of leveraged-ETF performance (ignoring taxes and expense ratios) is actually closer to the theory discussed in previous sections than margin investing is, because leveraged ETFs rebalance daily and so hold more true to the assumption of constant leverage. Moreover, within a few months, monthly rebalanced ETFs <a href="http://www.aabri.com/manuscripts/10676.pdf" title="'Daily vs. monthly rebalanced leveraged funds'">show similar trends</a> as daily-rebalanced ETFs do, so I don't think rebalancing frequency per se is a huge factor. My best guess is the rebalancing matters mainly through how leveraged it makes you: The more frequently you rebalance back up to 2X leverage, the higher your actual leverage amount is averaged over time.

Most academic studies seem to agree with this conclusion, though at least one may disagree: ``leveraged ETFs, on average, outperform the regular ETFs and the indexes but they are more hazardous." \cite{Rompotis}\footnote{This article is paywalled, so I haven't read more than its abstract.}

<h3>Looking at actual fund data</h3>

<h4>2X fund: SSO</h4>

With all these warnings, I wanted to check that my understanding of leveraged-ETF performance was accurate. In theory, a leveraged ETF's daily return should be 2X the daily return of the underlying ETF, minus daily fees and interest. Is this true in actual data, or are there other gotchas that contribute to poor long-run performance?

In this <a href="https://docs.google.com/spreadsheets/d/1g2B0vZwePiaJ0ypqTqe_jheLBF25qNRtb-H2eoDcNik/edit#gid=0">spreadsheet</a>, I gathered from Yahoo Finance historical data the adjusted closing prices for SPY (an S&P 500 ETF) and SSO (a 2X fund on top of the S&P 500). I calculated daily returns for SPY and then computed predicted daily returns for SSO as
<blockquote>
2*(return of SPY) - (some constant for fees+interest).
</blockquote>
I normalized so that the starting prices on 3 Jan. 2007 were the same, and then I adjusted the fees+interest constant such that the ending prices on 2 Apr. 2015 were also the same. The average absolute percent error between the predicted SSO price and the actual SSO price on any given day was 3.3%, and the max error was 8.9%. The fitting constant turned out to be 2.26%. This made a lot of sense, because SSO's <a href="http://www.proshares.com/funds/sso.html" title="'ProShares ETFs: Ultra S&amp;P500 - Overview'">expense ratio is</a> 0.89%, and margin rates at Interactive Brokers are ~1% to 1.5%. So 2.26% seems about right for the combination of expense ratio and interest charges.

To ensure that my prediction formula was actually good and that I wasn't just fitting any old formula by choosing the fees+interest constant properly, I added another dummy column to my spreadsheet that used the formula
<blockquote>
3*(return of SPY) minus (some other constant for fees+interest).
</blockquote>
Using the same procedure as before, I found that the fees+interest constant had to be -0.85% (which doesn't make sense). The average absolute error per day was 27%, and the max error was 64%. So it didn't appear that I could fit any formula well by choosing the constant appropriately.

<h4>2X fund: EET</h4>

I <a href="https://docs.google.com/spreadsheets/d/1g2B0vZwePiaJ0ypqTqe_jheLBF25qNRtb-H2eoDcNik/edit#gid=1507917387">ran the same procedure</a> for a different 2X fund: ProShares Ultra MSCI Emerging Markets (EET). It targets 2X daily returns of the MSCI Emerging Markets index, which can be tracked with EEM. The implied fees+interest was only 0.013. Considering that EET <a href="http://www.proshares.com/media/fact_sheet/ProSharesFactSheetEET.pdf" title="'Fact Sheet as of 3/31/15 ProShares Ultra MSCI Emerging Markets'">has an expense ratio of</a> 0.0095, that translates to implied interest of 0.0035 (or 0.35%). If that's accurate, it would put the fees+interest for EET on par with the interest alone for margin investing at Interactive Brokers, in which case EET investors wouldn't be at a disadvantage relative to margin investors due to expenses.

When fitting predicted vs. actual EET prices, the average absolute daily error was only 0.5%, and the max was 2.7%. In contrast, trying to fit a 3X formula gave average daily error of 9.6% and max error of 33%.

EEM's empirical annual &sigma; between 4 Jun. 2009 and 1 May 2015 was 0.23, and its annual &mu; was 0.089.

<h4>3X fund: EDC</h4>

I <a href="https://docs.google.com/spreadsheets/d/1g2B0vZwePiaJ0ypqTqe_jheLBF25qNRtb-H2eoDcNik/edit#gid=2110833699">ran the same procedure</a> for a 3X fund: Direxion Daily Emrg Mkts Bull 3X ETF (EDC). It targets 3X daily returns of MSCI Emerging Markets index, which can be tracked with EEM. The implied fees+interest was weirdly low: 0.000094. Considering that EDC <a href="http://www.direxioninvestments.com/products/direxion-daily-emerging-markets-bull-3x-etf" title="'Direxion Daily Emerging Markets Bull & Bear 3x Shares'">has an expense ratio of</a> 0.0095, that translates to implied interest of -0.0094. Hmm.

When fitting predicted vs. actual EDC prices, the average absolute daily error was 1.2%, and the max was 8.8%. In contrast, trying to fit a 2X formula gave average daily error of 11% and max error of 32%.

<h4>3X fund: UMDD</h4>

I <a href="https://docs.google.com/spreadsheets/d/1g2B0vZwePiaJ0ypqTqe_jheLBF25qNRtb-H2eoDcNik/edit#gid=791037557">ran the same procedure</a> for another 3X fund: ProShares UltraPro MidCap400 (UMDD). It targets 3X daily returns of the S&P MidCap 400 Index (^MID). The implied fees+interest was strangely negative: -0.00009. Considering that UMDD <a href="http://www.proshares.com/funds/umdd.html" title="'UltraPro MidCap400'">has an expense ratio of</a> 0.0095, that translates to implied interest of -0.0096. Hmm.

When fitting predicted vs. actual UMDD prices, the average absolute daily error was only 0.18%, and the max was 3.6%. In contrast, trying to fit a 2X formula gave average daily error of 7.5% and max error of 30%.

The annual &sigma; for ^MID between 11 Feb. 2010 and 5 May 2015 was 0.19, and the annual &mu; was 0.16 (which is obviously too high as a long-term estimate because the years covered corresponded to a bull market).

<h3>Actual performance data for some leveraged funds</h3>

The following tables use adjusted closing prices from Yahoo Finance historical data. Due to the overlap in time periods, the numbers are obviously correlated. Unfortunately most leveraged ETFs are new, so it's hard to find ones that extended back into to bear markets. Probably if I had more data from 2007-2008, the leveraged funds would look terrible.

<h4>2X funds</h4>

<table>
<tr><td><i>Regular + leveraged funds</i></td> <td><i>Regular initial price (S<sub>0</sub>)</i></td> <td><i>Regular final price (S<sub>t</sub>)</i></td> <td><i>Regular final/initial (S<sub>t</sub>/S<sub>0</sub>)</i></td> <td><i>Leveraged initial price (V<sub>0</sub>)</i></td> <td><i>Leveraged final price (V<sub>t</sub>)</i></td> <td><i>Leveraged final/initial (V<sub>t</sub>/V<sub>0</sub>)</i></td> <td><i>(V<sub>t</sub>/V<sub>0</sub>)/(S<sub>t</sub>/S<sub>0</sub>)</i></td></tr>
<tr><td>EEM vs. EET (4 Jun. 2009 to 1 May 2015)</td> <td>29.95</td> <td>43.14</td> <td>1.44</td> <td>57.93</td> <td>80.55</td> <td>1.39</td> <td><span style="color:red">0.97</span></td></tr>
<tr><td>^RUT vs. SMLL (29 Jul. 2014 to 1 May 2015)</td> <td>1,141.64</td> <td>1,228.10</td> <td>1.08</td> <td>121.74</td> <td>140.40</td> <td>1.15</td> <td><span style="color:green">1.07</span></td></tr>
<tr><td>SPY vs. SSO (21 Jun. 2006 to 1 May 2015)</td> <td>104.33</td> <td>210.72</td> <td>2.02</td> <td>61.75</td> <td>134.45</td> <td>2.18</td> <td><span style="color:green">1.08</span></td></tr>
<tr><td>EWJ vs. EZJ (5 Jun. 2009 to 1 May 2015)</td> <td>8.45</td> <td>13.02</td> <td>1.54</td> <td>56.99</td> <td>101.93</td> <td>1.79</td> <td><span style="color:green">1.16</span></td></tr>
<tr><td>VGK vs. UPV (7 May 2010 to 1 May 2015)</td> <td>33.39</td> <td>56.97</td> <td>1.71</td> <td>23.21</td> <td>50.75</td> <td>2.19</td> <td><span style="color:green">1.28</span></td></tr><!--NEW ROW IF NEEDED: <tr><td> vs.  ( to 1 May 2015)</td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td></tr>-->
</table>
If you had initially held $1 in each regular fund of this table, you would have ended with $7.78, while if you had held $1 in each leveraged fund from the table, you would have ended with $8.70.

<h4>3X funds</h4>

<table>
<tr><td><i>Regular + leveraged funds</i></td> <td><i>Regular initial price (S<sub>0</sub>)</i></td> <td><i>Regular final price (S<sub>t</sub>)</i></td> <td><i>Regular final/initial (S<sub>t</sub>/S<sub>0</sub>)</i></td> <td><i>Leveraged initial price (V<sub>0</sub>)</i></td> <td><i>Leveraged final price (V<sub>t</sub>)</i></td> <td><i>Leveraged final/initial (V<sub>t</sub>/V<sub>0</sub>)</i></td> <td><i>(V<sub>t</sub>/V<sub>0</sub>)/(S<sub>t</sub>/S<sub>0</sub>)</i></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=RSX&a=04&b=25&c=2011&d=04&e=6&f=2015&g=d">RSX</a> vs. <a href="http://finance.yahoo.com/q/hp?s=RUSL+Historical+Prices">RUSL</a> (25 May 2011 to 5 May 2015)</td> <td>32.96</td> <td>20.23</td> <td>0.61</td> <td>766.76</td> <td>34.45</td> <td>0.04</td> <td><span style="color:red">0.07</td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=ILF&a=11&b=3&c=2009&d=04&e=6&f=2015&g=d">ILF</a> vs. <a href="http://finance.yahoo.com/q/hp?s=LBJ+Historical+Prices">LBJ</a> (3 Dec. 2009 to 5 May 2015)</td> <td>42.33</td> <td>32.57</td> <td>0.77</td> <td>83.04</td> <td>11.69</td> <td>0.14</td> <td><span style="color:red">0.18</span></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=EWZ&a=03&b=10&c=2013&d=04&e=6&f=2015&g=d">EWZ</a> vs. <a href="http://finance.yahoo.com/q/hp?s=BRZU+Historical+Prices">BRZU</a> (10 Apr. 2013 to 5 May 2015)</td> <td>52.22</td> <td>36.59</td> <td>0.70</td> <td>42.13</td> <td>7.86</td> <td>0.19</td> <td><span style="color:red">0.27</span></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=EEM&a=11&b=30&c=2008&d=04&e=6&f=2015&g=d">EEM</a> vs. <a href="http://finance.yahoo.com/q/hp?s=EDC+Historical+Prices">EDC</a> (30 Dec. 2008 to 5 May 2015)</td> <td>22.00</td> <td>42.92</td> <td>1.95</td> <td>16.71</td> <td>28.80</td> <td>1.72</td> <td><span style="color:red">0.88</span></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=EFA&a=11&b=17&c=2008&d=04&e=6&f=2015&g=d">EFA</a> vs. <a href="http://finance.yahoo.com/q/hp?s=DZK+Historical+Prices">DZK</a> (17 Dec. 2008 to 5 May 2015)</td> <td>37.26</td> <td>66.18</td> <td>1.78</td> <td>38.91</td> <td>71.64</td> <td>1.84</td> <td><span style="color:green">1.04</span></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=%5ERUT&a=01&b=11&c=2010&d=04&e=6&f=2015&g=d">^RUT</a> vs. <a href="http://finance.yahoo.com/q/hp?s=URTY+Historical+Prices">URTY</a> (11 Feb. 2010 to 5 May 2015)</td> <td>605.46</td> <td>1,215.42</td> <td>2.01</td> <td>20.82</td> <td>95.12</td> <td>4.57</td> <td><span style="color:green">2.28</span></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=%5EMID&a=01&b=11&c=2010&d=04&e=6&f=2015&g=d">^MID</a> vs. <a href="http://finance.yahoo.com/q/hp?s=UMDD+Historical+Prices">UMDD</a> (11 Feb. 2010 to 5 May 2015)</td> <td>710.49</td> <td>1,500.00</td> <td>2.11</td> <td>20.73</td> <td>125.27</td> <td>6.04</td> <td><span style="color:green">2.86</span></td></tr>
<tr><td><a href="http://finance.yahoo.com/q/hp?s=SPY&a=05&b=25&c=2009&d=04&e=6&f=2015&g=d">SPY</a> vs. <a href="http://finance.yahoo.com/q/hp?s=UPRO+Historical+Prices">UPRO</a> (25 Jun. 2009 to 5 May 2015)</td> <td>81.99</td> <td>208.90</td> <td>2.55</td> <td>14.34</td> <td>137.59</td> <td>9.59</td> <td><span style="color:green">3.77</span></td></tr>
</table>
If you had initially held $1 in each regular fund of this table, you would have ended with $12.48, while if you had held $1 in each leveraged fund from the table, you would have ended with $11.35.


----
----


copy remaining stuff from tex piece!! including ETNs and the thing about higher EV

add http://www.dailyfinance.com/2010/02/09/exotic-etfs-may-hide-an-unpleasant-tax-surprise/
add thing about separating initial vs. maint marg and not tying to broker max to improvements section
zzz
http://etfdb.com/2013/the-curious-case-of-leveraged-etfs-understanding-how-compounding-works/
http://finance.yahoo.com/news/7-mistakes-avoid-trading-leveraged-130053722.html
http://www.etf.com/publications/journalofindexes/joi-articles/6414-understanding-returns-of-leveraged-and-inverse-funds.html?showall=&fullart=1&start=7
http://www.ijac.org.uk/images/frontImages/gallery/Vol._2_No._4_April_2013/3.pdf


explain that I did taxes as (1-tax_rate) because I wanted daily ganis to offset daily losses, even though this is wrong in terms of annual net loss b/c can't deduct whole loss! so this makes etfs look better tax-wise than is raelity


improvements:
diff maint vs. initi margin
don't tie investor's margin at exactly 90% of regular b/c real margin accounts might allow up to 4X



http://www.bogleheads.org/wiki/Leverage

http://www.bogleheads.org/wiki/The_Twelve_Pillars_of_Wisdom

<h3>A simple simulation</h3>

In contrast to the elaborate margin simulation described above, I created a barebones leveraged-ETF simulation. Part of the motivation for making it simple was to reduce the probability of errors. This simulation involves a regular ETF and a 2X leveraged-ETF, starting out at the same initial balance and updating in response to the same daily market returns. The market parameters are the same as for the margin simulation.

The daily return for the regular ETF is
<blockquote>
daily_return - regular_ETF_daily_expense_ratio,
</blockquote>
with regular_ETF_daily_expense_ratio = 0.1%/(252 trading days per year), since index ETFs tend to have expense ratios around 0.1%.

The return of the leveraged ETF is
<blockquote>
2 * daily_return - daily_interest_rate - leveraged_ETF_daily_expense_ratio.
</blockquote>
WHAT SHOULD I USE FOR INTEREST RATE??? I took leveraged_ETF_daily_expense_ratio = 1%/(252 trading days per year), since as discussed above, the expense ratio of the 2X fund SSO <a href="http://www.proshares.com/funds/sso.html" title="'ProShares ETFs: Ultra S&amp;P500 - Overview'">is</a> 0.89%.

Following are some graphs showing, on a single run of the simulation, how the leveraged ETF compared with a regular ETF on the same underlying asset. These graphs look a lot like those you'll find online comparing actual leveraged ETFs against their underlying indices.

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_sample_traj0</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_sample_traj1</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_sample_traj2</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_sample_traj3</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_sample_traj4</REPLACE>" title="I release this image into the public domain worldwide." /></span>

These graphs give excellent intuition for the performance of leveraged ETFs. Most of the time, even if the market goes up as a whole, the leveraged fund does worse. But every once in a while, the market goes up enough days in a row that the leveraged fund blows the regular fund out of the water. These lucky events account for a lot of the overall expected value of the leveraged fund.

<h3>Results vs. theory</h3>

To compare the results of my simple simulation against theory, I used basically the same leverage equations as for margin investing. The only difference is that because the expense ratio of the ETF is now significant (at least for the leveraged ETF), I include it in the equations, using the symbol f. In other words, for the regular ETF:
<blockquote>
dS<sub>t</sub>/S<sub>t</sub> = (&mu;-f) dt + &sigma; dW<sub>t</sub>.
</blockquote>
And for the leveraged ETF:
<blockquote>
dV<sub>t</sub>/V<sub>t</sub> = (r + (&mu;-r)c) dt - f dt + c &sigma; dW<sub>t</sub>.
</blockquote>
These equations assume the expense ratio is subtracted continuously, which presumably isn't true in practice.

In order to help my simulation results match theory, I removed black swans. The following table shows the results when doing so:

<REPLACE>ETF_match_theory_results_table</REPLACE>

As you can see, leveraged ETFs usually lose! It's no wonder they're discouraged for most investors.

Now to compare these numbers against theory:

<h4>Regular ETF</h4>

The following equations can be derived in the same ways as before. Everything is the same except that there's an extra -ft term representing the fund's expenses.

<h5>Median</h5>

<blockquote>
theoretical discounted median(S<sub>t</sub>) = S<sub>0</sub> exp((&mu;-f)t - &sigma;<sup>2</sup>t/2) exp(-&mu;t) = S<sub>0</sub> exp(-ft - &sigma;<sup>2</sup>t/2) = <REPLACE>starting_balance_for_leveraged_ETF_sim</REPLACE> * exp(-<REPLACE>regular_ETF_expense_ratio</REPLACE> * <REPLACE>years_until_donate</REPLACE> - <REPLACE>annual_sigma</REPLACE><sup>2</sup> * <REPLACE>years_until_donate</REPLACE>/2) = <REPLACE>theoretical_median_regular_ETF</REPLACE><br />
empirical discounted median (from above table) = <REPLACE>actual_median_regular_ETF</REPLACE>
</blockquote>

<h5>Mean</h5>

<blockquote>
theoretical discounted mean(S<sub>t</sub>) = S<sub>0</sub> exp((&mu;-f)t) exp(-&mu;t) = S<sub>0</sub> exp(-ft) = <REPLACE>starting_balance_for_leveraged_ETF_sim</REPLACE> * exp(-<REPLACE>regular_ETF_expense_ratio</REPLACE> * <REPLACE>years_until_donate</REPLACE>) = <REPLACE>theoretical_mean_regular_ETF</REPLACE><br />
empirical discounted mean (from above table) = <REPLACE>actual_mean_regular_ETF</REPLACE>
</blockquote>

<h4>Leveraged ETF</h4>

<h5>Median</h5>

<blockquote>
theoretical discounted median(V<sub>t</sub>) = V<sub>0</sub> exp{(&mu;-r)(c-1)t - ft - c<sup>2</sup>&sigma;<sup>2</sup>t/2} = <REPLACE>starting_balance_for_leveraged_ETF_sim</REPLACE> * exp{(<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>) * (<REPLACE>LEV_ETF_LEVERAGE_RATIO</REPLACE>-1) * <REPLACE>years_until_donate</REPLACE> - <REPLACE>lev_ETF_expense_ratio</REPLACE> * <REPLACE>years_until_donate</REPLACE> - <REPLACE>LEV_ETF_LEVERAGE_RATIO</REPLACE><sup>2</sup> * <REPLACE>annual_sigma</REPLACE><sup>2</sup> * <REPLACE>years_until_donate</REPLACE>/2} = <REPLACE>theoretical_median_lev_ETF</REPLACE><br />
empirical discounted median (from above table) = <REPLACE>actual_median_lev_ETF</REPLACE>
</blockquote>

<h5>Mean</h5>

<blockquote>
theoretical discounted mean(V<sub>t</sub>) = V<sub>0</sub> exp{(&mu;-r)(c-1)t - ft} = <REPLACE>starting_balance_for_leveraged_ETF_sim</REPLACE> * exp{(<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>) * (<REPLACE>LEV_ETF_LEVERAGE_RATIO</REPLACE>-1) * <REPLACE>years_until_donate</REPLACE> - <REPLACE>lev_ETF_expense_ratio</REPLACE> * <REPLACE>years_until_donate</REPLACE>} = <REPLACE>theoretical_mean_lev_ETF</REPLACE><br />
empirical discounted mean (from above table) = <REPLACE>actual_mean_lev_ETF</REPLACE>
</blockquote>

<h3>Daily vs. monthly rebalancing</h3>

This simple leveraged-ETF simulation doesn't record actual margin or asset amounts but merely relies on the principle that the leveraged fund's daily return is roughly 2 times that of the underlying index. The approximation that the daily return is 2X the underlying return should be roughly true if the fund rebalances daily.

What if the fund rebalances monthly? In this case, the fund's return over the month isn't exactly 2X the underlying return that month because the leverage ratio doesn't remain constant at 2X during the whole month. For instance, if the fund gained in value, its leverage would have fallen below 2X, so that the monthly return of the leveraged fund should be somewhat less than 2X that of the underlying index.

My margin simulations did keep track of margin and asset totals given daily changes in prices, and they rebalanced monthly. So if we strip away the other complexities of the margin simulation, it should approximate the simple leveraged ETF simulation but with exact monthly rebalancing. I presented the results for the barebones version of the margin simulation previously, but for reference, here they are again:

<REPLACE>closetotheory_results_table</REPLACE>

These aren't quite comparable to the daily-rebalanced leveraged-ETF results just presented because my leveraged-ETF simulations include an expense ratio, while the margin simulations didn't (or had a very tiny expense ratio in the form of trading fees). So here are the results of the leveraged-ETF simulation if the expense ratios are set to 0:

<REPLACE>ETF_match_theory_no_exp_ratios_results_table</REPLACE>

<!-- NOT TRUE ANYMORE?:
For some reason, daily rebalancing has a lower expected value than monthly rebalancing.<span style="color:orange">CHECK THIS MANUALLY</span> This seems wrong because it contradicts the trend observed in previous sections that more frequent rebalancing (monthly rather than never) gave higher expected returns. Maybe there's some optimal rebalancing frequency greater than daily, but more likely this difference results from some difference between my two simulations that I haven't yet tracked down. -->

<h3>With default parameters</h3>

The above results were designed to match theory. Now I show results if we use the "default" parameters from the margin simulations above, including black swans, inflation, monthly paychecks, unemployment, and emergency savings.

<REPLACE>ETF_default_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>ETF_default_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>3X leverage</h3>

The following results use the same "default" parameters as above except with 3X leverage instead of 2X.

<REPLACE>ETF_default_3X_results_table</REPLACE>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

Sample trajectories:

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_sample_traj0</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_sample_traj1</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_sample_traj2</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_sample_traj3</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_3X_sample_traj4</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h3>Various tax rates</h3>

As noted <a href="#arguments_against_leveraged_ETFs">previously</a>, leveraged ETFs can occasionally have unpleasant tax consequences if the fund turns over a large portion of its assets. I ran versions of my leveraged-ETF simulations that attempted to crudely incorporate taxes, by multiplying each day's return by (1 - short_term_capital_gains_tax_rate * percent_assets_with_gains). In the "medium" tax scenario, percent_assets_with_gains was 15%, and in the "high" tax scenario, it was 75%. (In the results presented above, the default percent of assets taxed is 0%.)

Multiplying daily returns is suboptimal because if the year has a big capital loss, multiplying by (1-tax_fraction) dampens that loss. But in reality, you can't deduct more than a given amount of capital loss per year, so the (1-tax_fraction) factor may actually make performance look better than it would be in practice. I didn't have an easy way to fix this problem without making the simulation much more complicated. So take these results with sample sodium chloride.

<h4>Leveraged ETF only pays short-term taxes on 10% of assets per year</h4>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_moderate_taxes_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>ETF_default_moderate_taxes_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h4>Leveraged ETF only pays short-term taxes on 50% of assets per year</h4>

<span class="fullwidthimage"><img src="<REPLACE>ETF_default_high_taxes_exp_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>
<span class="fullwidthimage"><img src="<REPLACE>ETF_default_high_taxes_exp_sat_util</REPLACE>" title="I release this image into the public domain worldwide." /></span>

<h2>Leveraged ETFs vs. margin investing</h2>

It seems as though leveraged ETFs offer similar performance characteristics as ordinary constant-leverage margin investing. Leveraged ETFs are temptingly easy compared with do-it-yourself margin accounts.

<h3>Analysis without taxes</h3>

Apart from taxes, the main drawback is the high expense ratios of leveraged ETFs. Let's say leveraged ETFs have expense ratios of 1%, while ordinary index ETFs have expense ratios of 0.1%. Ignore the difference between daily vs. monthly rebalancing, and assume for simplicity that both forms of leveraged investing use continuous constant-leverage rebalancing. Also ignore black swans, since both approaches will face similar problems there. Say the manual work involved with managing a margin account is $W per year more than that to buy shares in a leveraged ETF. Then we have
<blockquote>
theoretical discounted mean of LevETF<sub>t</sub> counting manual effort = LevETF<sub>0</sub> exp{(&mu;-r)(c-1)t - 0.01t}
</blockquote>
and 
<blockquote>
theoretical discounted mean of MarginAccount<sub>t</sub> counting manual effort = MarginAccount<sub>0</sub> exp{(&mu;-r)(c-1)t - 0.001t} - Wt.
</blockquote>
Assume equal starting amounts of money: LevETF<sub>0</sub> = MarginAccount<sub>t</sub> = K. At what K does it become more cost-effective to use a manual margin account?
<blockquote>
K exp{(&mu;-r)(c-1)t - 0.01t} < K exp{(&mu;-r)(c-1)t - 0.001t} - Wt  &nbsp;&nbsp;&nbsp;  (call this the "<span id="ETF_vs_margin_without_taxes" style="color:green">ETF-vs-margin-without-taxes equation</span>")<br />
K exp{(&mu;-r)(c-1)t} exp(-0.01t) < K exp{(&mu;-r)(c-1)t} exp(-0.001t) - Wt<br />
Wt < K exp{(&mu;-r)(c-1)t} exp(-0.001t) - K exp{(&mu;-r)(c-1)t} exp(-0.01t)<br />
Wt < K exp{(&mu;-r)(c-1)t} [ exp(-0.001t) - exp(-0.01t) ]<br />
Wt / ( exp{(&mu;-r)(c-1)t} [ exp(-0.001t) - exp(-0.01t) ] ) < K.<br />
</blockquote>
Suppose that managing the margin account takes 3 hours per month. On most months it would probably take far less time once you got the hang of things, but on some months you might run into problems, need technical support, etc. Also, doing taxes might be annoying.((Tax records for Interactive Brokers currently <a href="https://ttlc.intuit.com/questions/2478576-tt-doesn-t-support-interactive-brokers" title="'TT doesn't support Interactive Brokers?'">can't be imported</a> to TurboTax Online, only to the desktop version with <a href="https://ibkb.interactivebrokers.com/article/2030" title="'Steps for Importing Worksheet for Form 8949 to TurboTax'">more hassle</a>.)) Say your time is worth $50 donated per hour. Then W = (3 hours/month)($50/hour)(12 months/year) = $1800/year. Plugging in this and our other standard parameter values to the above inequality:
<blockquote>
K > 1800 * <REPLACE>years_until_donate</REPLACE> / ( exp{(<REPLACE>annual_mu</REPLACE>-<REPLACE>annual_margin_interest_rate</REPLACE>)(<REPLACE>broker_imposed_leverage_limit</REPLACE>-1) * <REPLACE>years_until_donate</REPLACE>} [ exp(-0.001 * <REPLACE>years_until_donate</REPLACE>) - exp(-0.01 * <REPLACE>years_until_donate</REPLACE>) ] ) = <REPLACE>default_K_threshold</REPLACE>.
</blockquote>
Here are some other values of the K threshold with different parameter inputs:
<table>
<tr><td><i>Params different from default</i></td> <td>Better to do manually if you invest more than ...</td></tr>
<tr><td>&mu; = .09</td> <td><REPLACE>mu09_K_threshold</REPLACE></td></tr>
<tr><td>W = $500</td> <td><REPLACE>W500_K_threshold</REPLACE></td></tr>
<tr><td>W = $4000</td> <td><REPLACE>W4000_K_threshold</REPLACE></td></tr>
<tr><td>&mu; = .09, W = $1000</td> <td><REPLACE>W1000_mu09_K_threshold</REPLACE></td></tr>
<tr><td>leveraged fund's expense ratio is 0.005</td> <td><REPLACE>levexpr005_K_threshold</REPLACE></td></tr>
<tr><td>3X leveraged fund</td> <td><REPLACE>lev3X_K_threshold</REPLACE></td></tr>
</table>
One reason to set W high is that there's some small risk that you'll mess things up badly trying to manage the account on your own. For instance, say you have $300K invested, and there's a 1% chance that you make a mistake that costs you 10% of your assets ($30K), then this would increase W by $300 annually.

<span style="color:red">check the above #s by hand once</span>

On the other hand, these numbers ignore taxes from leveraged ETFs, which might be an important additional argument favoring manual margin investing, so we incorporate taxes in the next subsection.

<h3>Analysis with taxes</h3>

For simplicity, assume a leveraged ETF pays short-term capital-gains taxes continuously on a constant fraction F of its holdings (say, F = .05), with the investor's marginal short-term tax rate being R (say R = .28). Since I think ETFs carry forward capital losses, it's not too inaccurate to pretend that taxes multiply any return by (1-FR), even though in practice, an investor can't deduct losses beyond $3K/year but pays taxes on capital gains without limit.

The leveraged-ETF SDE is now
<blockquote>
dV<sub>t</sub>/V<sub>t</sub> = (1-FR) [ (r + (&mu;-r)c) dt + c &sigma; dW<sub>t</sub> ] - f dt.
</blockquote>
(This assumes that margin interest is deductible. That's true for margin accounts. Is it also true for the implied interest that leveraged ETFs get from swaps, options, etc.??)

Solving in the same way we solved the original <a href="#leveraged_V_t">leveraged V<sub>t</sub> equation</a>:
<blockquote>
V<sub>t</sub> = V<sub>0</sub> exp{ (1-FR)(r + (&mu;-r)c) t - ft - (1-FR)<sup>2</sup>c<sup>2</sup>&sigma;<sup>2</sup>t/2 + (1-FR)c&sigma;W<sub>t</sub> }.
</blockquote>
Then, in analogy with the <a href="#leveraged_mean">leveraged mean equation</a>:
<blockquote>
mean(V<sub>t</sub>) = V<sub>0</sub> exp(location_parameter + scale_parameter<sup>2</sup>/2)<br />
= V<sub>0</sub> exp{ (1-FR)(r + (&mu;-r)c) t - ft - (1-FR)<sup>2</sup>c<sup>2</sup>&sigma;<sup>2</sup>t/2 + (1-FR)<sup>2</sup>c<sup>2</sup>&sigma;<sup>2</sup>t/2 }<br />
= V<sub>0</sub> exp{ (1-FR)(r + (&mu;-r)c) t - ft }.
</blockquote>
The discounted mean is then
<blockquote>
discounted mean(V<sub>t</sub>) = V<sub>0</sub> exp{ (1-FR)(r + (&mu;-r)c) t - ft } exp(-&mu;t)<br />
= V<sub>0</sub> exp{ (1-FR)(r + (&mu;-r)c) t - (1-FR)&mu;t - FR&mu;t - ft }<br />
= V<sub>0</sub> exp{ (1-FR)(&mu;-r)(c-1)t - (FR&mu; + f)t }.
</blockquote>
Modifying the <a href="#ETF_vs_margin_without_taxes">ETF-vs-margin-without-taxes equation</a> to include taxes:
<blockquote>
K exp{(1-FR)(&mu;-r)(c-1)t - (FR&mu; + 0.01)t} < K exp{(&mu;-r)(c-1)t - 0.001t} - Wt<br />
Wt < K [ exp{(&mu;-r)(c-1)t - 0.001t} - exp{(1-FR)(&mu;-r)(c-1)t - (FR&mu; + 0.01)t} ]<br />
K > Wt / [ exp{(&mu;-r)(c-1)t - 0.001t} - exp{(1-FR)(&mu;-r)(c-1)t - (FR&mu; + 0.01)t} ]<br />
</blockquote>
Here are some values of the threshold for various param combinations, with default F = .05 and R = .28:
<table>
<tr><td><i>Params different from default</i></td> <td>Better to do manually if you invest more than ...</td></tr>
<tr><td>default</td> <td><REPLACE>default_K_threshold_with_taxes</REPLACE></td></tr>
<tr><td>R = .14 (this is a 28% bracket <a href="http://reducing-suffering.org/advanced-tips-on-personal-finance/#Marginal_tax_rate_halved_when_you_donate_a_lot">if you donate at least half</a> your income)</td> <td><REPLACE>R14_K_threshold_with_taxes</REPLACE></td></tr>
<tr><td>F = .2</td> <td><REPLACE>F20_K_threshold_with_taxes</REPLACE></td></tr>
<tr><td>F = .2, R = .14</td> <td><REPLACE>F20R14_K_threshold_with_taxes</REPLACE></td></tr>
</table>

Interestingly, taxes make a much smaller difference than the expense ratio. To see this, note that the expense ratio for a leveraged ETF subtracts 0.01t from the quantity in the exponent. In contrast, taxes subtract FR&mu;t + FR(&mu;-r)(c-1)t = FR(&mu;+(&mu;-r)(c-1))t. Assuming low c, this is like FR * (something around .1 or .2) * t. Since F is also around .1 or .3, the result is F * (something around .01 to .06) * t. As long as F isn't close to 1 (which it's not in most years for most leveraged ETFs), taxes end up mattering less than expense ratios. Even if leveraged-ETF interest isn't tax-deductible (which means we'd ignore the -r parts of these calculations), the conclusion continues to hold. Hence, taxes may not be as much as a big bad wolf as one might have feared.

<h2>My plan for using leverage</h2>

The following was written in May 2015. It may have changed by the time you read it.

When I resume earning to give, I'll probably do something like this:
<ul>
<li>Donate some of my earnings during the year to charities in whose value I'm already pretty confident. The main reason to give now is that the charities I want to support have only so much room to grow in a given amount of time (like a sponge has only so much room to soak up water), so it's better to donate small amounts steadily than to donate large lump sums rarely.</li>
<li>If that doesn't use 50% of my income, give more to a donor-advised fund so that I've donated at least 50% of my income during that year for maximum tax deductions.</li>
<li>Of remaining money not saved for retirement or spent on costs of living, invest most of it with leverage. To reduce the hassle required, I'll probably use a 3X leveraged ETF rather than a margin account. 3X leverage is ok because it's fine if I lose all of this money, since I will have already donated to the most pressing charities, and this money is just a bonus.</li>
</ul>

To start, I'll buy small amounts (a few hundred $) of a few leveraged ETFs. This will help me see how they're taxed and whether there are other gotchas that only become visible once you own them. I also plan to read even more literature on leveraged ETFs to make sure I'm not missing something with my analysis, given that almost everyone agrees leveraged ETFs are not suitable for buy-and-hold investors. Theory predicts that many of the leveraged ETFs I buy will lose value, so it's not as though early feedback with leveraged-ETF performance would be enough to convince me the strategy was wrong-headed.

Originally I was going to do margin investing. I might still play with it a bit to see how it goes. I've opened a margin account with Interactive Brokers. I transferred a small amount of stocks in from my previous broker, Fidelity, so that I can play around with margin investing in a low-risk way. I also would like to go through a tax cycle before investing more in Interactive Brokers, to make sure that reporting the transactions on taxes isn't too burdensome.

WHAT'S THE final calculated ADVANTAGE OF MARGIN?

<h2>A note on refreshing this essay</h2>

I originally wrote this piece by copying and pasting static results into an HTML file. However, I kept updating my code and thus found that I had to keep refreshing the results. Eventually I parameterized the inputs and results, so that I could dynamically generate this essay from the latest run of my simulations.

That means if I find bugs, add features, or change parameters, I can rerun my program and regenerate this essay with minimal manual work. That said, generating all the results using thousands of random samples per configuration might take up to a few weeks to run on my laptop.

<h2>Footnotes</h2>